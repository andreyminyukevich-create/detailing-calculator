<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–∫–ª–µ–π–∫–∏</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  /* Modern Color Palette */
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-tertiary: #334155;
  --card: rgba(255, 255, 255, 0.05);
  --card-hover: rgba(255, 255, 255, 0.08);
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --text-dimmed: #64748b;
  --border: rgba(148, 163, 184, 0.1);
  --border-hover: rgba(148, 163, 184, 0.2);
  
  /* Brand Colors */
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --primary-light: #60a5fa;
  --success: #10b981;
  --success-dark: #059669;
  --warning: #f59e0b;
  --warning-dark: #d97706;
  --danger: #ef4444;
  
  /* Effects */
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.2);
  --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.3);
  --glow-primary: 0 0 20px rgba(59, 130, 246, 0.3);
  --glow-success: 0 0 20px rgba(16, 185, 129, 0.3);
  
  /* Glassmorphism */
  --glass: rgba(255, 255, 255, 0.05);
  --glass-border: rgba(255, 255, 255, 0.1);
}

[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: #f1f5f9;
  --bg-tertiary: #e2e8f0;
  --card: rgba(255, 255, 255, 0.9);
  --card-hover: rgba(255, 255, 255, 1);
  --text: #0f172a;
  --text-muted: #475569;
  --text-dimmed: #64748b;
  --border: rgba(15, 23, 42, 0.08);
  --border-hover: rgba(15, 23, 42, 0.15);
  --glass: rgba(255, 255, 255, 0.8);
  --glass-border: rgba(15, 23, 42, 0.1);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  overflow-x: hidden;
  scroll-behavior: smooth;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg-primary);
  color: var(--text);
  line-height: 1.6;
  transition: background-color 0.3s ease, color 0.3s ease;
  -webkit-tap-highlight-color: transparent;
  overflow-x: hidden;
  position: relative;
}

/* Animated Background */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(16, 185, 129, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.08) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
  animation: backgroundPulse 20s ease-in-out infinite;
}

@keyframes backgroundPulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 0.8; }
}

/* Top Bar - Modern Design */
.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: var(--glass);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--glass-border);
  box-shadow: var(--shadow-md);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  animation: slideDown 0.5s ease-out;
}

@keyframes slideDown {
  from {
    transform: translateY(-100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.top-bar h1 {
  font-size: 1.1rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.02em;
}

@media (min-width: 768px) {
  .top-bar h1 {
    font-size: 1.3rem;
  }
}

.theme-toggle {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  min-height: 40px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.theme-toggle::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, var(--primary), var(--success));
  opacity: 0;
  transition: opacity 0.3s;
}

.theme-toggle:hover::before {
  opacity: 0.1;
}

.theme-toggle:active {
  transform: scale(0.95);
}

.theme-toggle span {
  position: relative;
  z-index: 1;
}

/* Main Container */
.main-container {
  padding-top: 90px; /* –£–≤–µ–ª–∏—á–∏–ª —Å 60px –¥–æ 90px */
  min-height: 100vh;
  position: relative;
  z-index: 1;
}

/* Mobile Layout */
@media (max-width: 767px) {
  .main-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 90px 16px 40px; /* –£–≤–µ–ª–∏—á–∏–ª –≤–µ—Ä—Ö–Ω–∏–π padding */
  }
  
  .left-column,
  .right-column {
    width: 100%;
  }
}

/* Desktop Layout */
@media (min-width: 768px) {
  .main-container {
    display: flex;
    gap: 24px;
    padding: 100px 24px 40px;
    max-width: 1400px;
    margin: 0 auto;
    align-items: flex-start;
  }
  
  .left-column {
    flex: 1;
    min-width: 0;
  }
  
  .right-column {
    width: 420px;
    min-width: 420px;
    max-width: 420px;
    flex-shrink: 0;
    position: sticky;
    top: 100px;
    align-self: flex-start;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
}

/* Modern Card Design */
.card {
  background: var(--card);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 20px;
  box-shadow: var(--shadow-md);
  padding: 24px;
  margin-bottom: 20px;
  border: 1px solid var(--border);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  animation: fadeInUp 0.6s ease-out backwards;
  position: relative;
  overflow: hidden;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }
.card:nth-child(5) { animation-delay: 0.5s; }

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), var(--success));
  opacity: 0;
  transition: opacity 0.3s;
}

.card:hover::before {
  opacity: 1;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
  border-color: var(--border-hover);
}

@media (min-width: 768px) {
  .card {
    padding: 28px;
  }
}

.card h2 {
  font-size: 1.15rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  min-height: 44px;
  letter-spacing: -0.02em;
  transition: all 0.3s;
}

.card h2:hover {
  color: var(--primary);
}

@media (min-width: 768px) {
  .card h2 {
    font-size: 1.3rem;
  }
}

.card h2::before {
  content: '';
  width: 4px;
  height: 24px;
  background: linear-gradient(180deg, var(--primary), var(--primary-light));
  border-radius: 4px;
  box-shadow: var(--glow-primary);
  transition: all 0.3s;
}

.card h2:hover::before {
  height: 28px;
  box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
}

.card h2.collapsible::after {
  content: '‚ñº';
  margin-left: auto;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-size: 0.9rem;
  opacity: 0.6;
}

.card h2.collapsible:hover::after {
  opacity: 1;
}

.card h2.collapsible.collapsed::after {
  transform: rotate(-90deg);
}

.card-content {
  transition: all 0.3s ease;
}

.card-content.collapsed {
  display: none;
}

/* Right column cards */
@media (min-width: 768px) {
  .right-column .card h2 {
    cursor: default;
  }
  
  .right-column .card h2::after {
    display: none;
  }
  
  .right-column .card {
    padding: 20px;
    margin-bottom: 0;
  }
}

/* Form Elements - Modern Style */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

label {
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 4px;
  display: block;
  font-size: 0.9rem;
  letter-spacing: -0.01em;
  transition: color 0.3s;
}

.form-group:focus-within label {
  color: var(--primary);
}

.markup-label {
  color: var(--warning);
  font-weight: 700;
}

input,
select {
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 16px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background: var(--bg-secondary);
  color: var(--text);
  width: 100%;
  min-height: 48px;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
}

@media (min-width: 768px) {
  input {
    padding: 12px 14px;
    font-size: 0.95rem;
    min-height: auto;
  }
  
  select {
    padding: 14px 16px; /* Keep larger padding for select */
    font-size: 16px; /* Keep larger font for select */
    min-height: 54px; /* Even taller than mobile! */
    height: 54px; /* Force height */
  }
}

input:hover,
select:hover {
  border-color: var(--border-hover);
}

input.markup-warning {
  background: rgba(245, 158, 11, 0.1);
  border-color: var(--warning);
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

input:focus,
select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), var(--glow-primary);
  transform: translateY(-1px);
}

input:read-only {
  background: var(--bg-tertiary);
  color: var(--text-dimmed);
  cursor: not-allowed;
}

/* Service Items - Modern */
.service-item {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.service-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, var(--primary), var(--success));
  opacity: 0;
  transition: opacity 0.3s;
}

.service-item:hover::before {
  opacity: 1;
}

.service-item:hover {
  border-color: var(--border-hover);
  transform: translateX(4px);
  box-shadow: var(--shadow-sm);
}

.service-header {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}

.service-header input[type="checkbox"] {
  width: 22px;
  height: 22px;
  margin: 0;
  cursor: pointer;
  min-height: auto;
  accent-color: var(--primary);
  border-radius: 6px;
}

.service-header label {
  font-weight: 600;
  color: var(--text);
  font-size: 0.95rem;
  margin: 0;
  cursor: pointer;
  flex: 1;
  transition: color 0.3s;
}

.service-header:hover label {
  color: var(--primary);
}

.service-body {
  margin-top: 16px;
  display: none;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.service-body.open {
  display: block;
}

.service-fields {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

.service-complexity {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: var(--text-muted);
  padding: 8px;
  background: var(--bg-tertiary);
  border-radius: 8px;
  transition: all 0.3s;
}

.service-complexity:hover {
  background: var(--card-hover);
}

.service-complexity input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin: 0;
  min-height: auto;
  accent-color: var(--primary);
}

/* Partial Elements */
.partial-wrapper {
  margin: 24px 0;
}

.partial-header {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  padding: 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 16px;
  user-select: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.partial-header:hover {
  border-color: var(--border-hover);
  transform: translateX(4px);
  box-shadow: var(--shadow-sm);
}

.partial-header input[type="checkbox"] {
  width: 22px;
  height: 22px;
  margin: 0;
  cursor: pointer;
  min-height: auto;
  accent-color: var(--primary);
}

.partial-header label {
  font-weight: 600;
  color: var(--text);
  font-size: 0.95rem;
  margin: 0;
  cursor: pointer;
  flex: 1;
}

.partial-content {
  margin-top: 16px;
  padding-left: 34px;
  display: none;
}

.partial-content.open {
  display: block;
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Buttons - Modern Gradient Style */
.btn {
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-height: 48px;
  touch-action: manipulation;
  position: relative;
  overflow: hidden;
  letter-spacing: -0.01em;
}

@media (min-width: 768px) {
  .btn {
    padding: 12px 18px;
    font-size: 0.95rem;
  }
}

.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.btn:active::before {
  width: 300px;
  height: 300px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  box-shadow: var(--shadow-md), var(--glow-primary);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg), 0 0 30px rgba(59, 130, 246, 0.4);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  background: var(--bg-secondary);
  color: var(--text);
  border: 2px solid var(--border);
  box-shadow: var(--shadow-sm);
}

.btn-secondary:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-hover);
  transform: translateY(-2px);
}

.btn-secondary:active {
  transform: translateY(0);
}

.btn-success {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
  color: #fff;
  box-shadow: var(--shadow-md), var(--glow-success);
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg), 0 0 30px rgba(16, 185, 129, 0.4);
}

.btn-success:active {
  transform: translateY(0);
}

/* Chips - Modern Pills */
.chips {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
}

.chip {
  padding: 10px 16px;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: 24px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color: var(--text);
  min-height: 44px;
  display: flex;
  align-items: center;
  touch-action: manipulation;
}

@media (min-width: 768px) {
  .chip {
    padding: 8px 14px;
    font-size: 0.85rem;
    min-height: auto;
  }
}

.chip:hover {
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md), var(--glow-primary);
}

.chip:active {
  transform: scale(0.95);
}

/* Discount Buttons */
.discount-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 12px;
}

@media (min-width: 768px) {
  .discount-grid {
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  }
}

.discount-btn {
  padding: 14px;
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
  border: 2px solid rgba(245, 158, 11, 0.3);
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-align: center;
  min-height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
  color: var(--text);
}

@media (min-width: 768px) {
  .discount-btn {
    padding: 10px 12px;
    font-size: 0.85rem;
    min-height: auto;
  }
}

.discount-btn:hover {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
  border-color: var(--warning);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.discount-btn:active {
  transform: scale(0.95);
}

.discount-btn.active {
  background: linear-gradient(135deg, var(--warning), var(--warning-dark));
  border-color: var(--warning);
  color: #fff;
  box-shadow: var(--shadow-md), 0 0 20px rgba(245, 158, 11, 0.3);
}

/* Toggle Group */
.toggle-group {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.toggle-btn {
  flex: 1;
  min-width: calc(50% - 4px);
  justify-content: center;
  padding: 12px;
  font-size: 0.9rem;
  font-weight: 600;
  background: var(--bg-secondary);
  border: 2px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  min-height: 48px;
  display: flex;
  align-items: center;
  touch-action: manipulation;
}

@media (min-width: 768px) {
  .toggle-btn {
    padding: 10px 16px;
  }
}

.toggle-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-hover);
  transform: translateY(-2px);
}

.toggle-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: #fff;
  border-color: var(--primary);
  box-shadow: var(--shadow-md), var(--glow-primary);
}

.toggle-btn:active {
  transform: scale(0.98);
}

/* Tables - Modern Design */
.table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 12px;
  margin-top: 16px;
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.8rem;
  min-width: 600px;
  background: var(--bg-secondary);
  border-radius: 12px;
  overflow: hidden;
}

@media (min-width: 768px) {
  table {
    font-size: 0.9rem;
  }
}

th,
td {
  padding: 12px 10px;
  text-align: center;
  border-bottom: 1px solid var(--border);
}

@media (min-width: 768px) {
  th,
  td {
    padding: 14px 12px;
  }
}

th {
  background: var(--bg-tertiary);
  font-weight: 700;
  color: var(--text);
  font-size: 0.85rem;
  letter-spacing: -0.01em;
}

tbody tr {
  transition: all 0.2s;
}

tbody tr:hover {
  background: var(--card-hover);
}

tbody tr:last-child td {
  border-bottom: none;
}

td:last-child {
  text-align: right;
  font-weight: 600;
}

#costTable td:nth-child(2),
#costTable td:nth-child(3) {
  text-align: right;
  font-weight: 600;
}

tfoot th {
  text-align: right;
  background: var(--bg-tertiary);
  font-weight: 700;
  padding: 16px 12px;
  font-size: 1rem;
}

tfoot th:first-child {
  text-align: left;
}

/* Totals Grid - Modern Cards */
.totals-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-top: 16px;
}

@media (min-width: 768px) {
  .totals-grid {
    grid-template-columns: 1fr 1fr;
  }
}

.total-item {
  text-align: center;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 16px;
  border: 1px solid var(--border);
  min-height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.total-item:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
  border-color: var(--border-hover);
}

@media (min-width: 768px) {
  .total-item {
    padding: 14px;
  }
}

.total-label {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 6px;
  font-weight: 600;
  letter-spacing: -0.01em;
}

@media (min-width: 768px) {
  .total-label {
    font-size: 0.8rem;
  }
}

.total-value {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.02em;
}

.final-total {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
  color: #fff;
  border: none;
  box-shadow: var(--shadow-md), var(--glow-success);
  position: relative;
  overflow: hidden;
}

.final-total::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

@media (min-width: 768px) {
  .final-total {
    grid-column: 1 / -1;
  }
}

.final-total .total-value {
  color: #fff;
  font-size: 1.5rem;
}

.final-total .total-label {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 700;
}

.final-total:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg), 0 0 40px rgba(16, 185, 129, 0.5);
}

/* Chart Container */
.chart-container {
  position: relative;
  height: 200px;
  margin-top: 16px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border: 1px solid var(--border);
}

@media (min-width: 768px) {
  .chart-container {
    height: 220px;
  }
}

/* Export Buttons */
.export-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  flex-direction: column;
}

@media (min-width: 768px) {
  .export-buttons .btn {
    font-size: 0.85rem;
    padding: 10px 12px;
  }
}

/* Package Grid */
.package-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
  margin-bottom: 16px;
}

@media (min-width: 768px) {
  .package-grid {
    grid-template-columns: 1fr 1fr;
  }
}

/* Summary Cards */
.summary-cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

/* Utility Classes */
.invis {
  display: none !important;
}

/* PDF Templates */
#pdfTemplates {
  display: none;
  font-family: Arial, sans-serif;
  font-size: 12px;
  line-height: 1.4;
}

#pdfTemplates .pdf-block {
  width: 210mm;
  min-height: 297mm;
  padding: 20mm;
  background: #fff;
  color: #000;
}

#pdfTemplates h1 {
  font-size: 18px;
  margin-bottom: 10px;
  text-align: center;
}

#pdfTemplates table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0;
}

#pdfTemplates th,
#pdfTemplates td {
  border: 1px solid #333;
  padding: 5px;
  text-align: left;
}

#pdfTemplates th {
  background: #f0f0f0;
  font-weight: bold;
}

/* Telegram Warning */
#telegramWarning {
  display: none;
  background: rgba(245, 158, 11, 0.1);
  border: 2px solid var(--warning);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  font-size: 0.9rem;
  color: var(--text);
  animation: pulse 2s ease-in-out infinite;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
  background: var(--bg-tertiary);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--border-hover);
}

/* Loading Animation */
@keyframes shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

.loading {
  animation: shimmer 2s infinite;
  background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-tertiary) 50%, var(--bg-secondary) 100%);
  background-size: 1000px 100%;
}
</style>
</head>
<body>
<div id="app">
<div class="top-bar">
  <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–∫–ª–µ–π–∫–∏</h1>
  <div class="theme-toggle" onclick="toggleTheme()">
    <span id="themeIcon">‚òÄÔ∏è</span>
  </div>
</div>

<div class="main-container">
  <!-- LEFT COLUMN -->
  <div class="left-column">
    
    <!-- –ê–≤—Ç–æ–º–æ–±–∏–ª—å -->
    <div class="card">
      <h2>üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</h2>
      <div class="card-content">
        <div class="form-group">
          <label>–ë—Ä–µ–Ω–¥:</label>
          <select id="brand">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
            <option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>
          </select>
          <input type="text" id="brandManual" placeholder="–í–≤–µ–¥–∏—Ç–µ –±—Ä–µ–Ω–¥" class="invis">
        </div>
        <div class="form-group">
          <label>–ú–æ–¥–µ–ª—å:</label>
          <select id="model">
            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
            <option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>
          </select>
          <input type="text" id="modelManual" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–æ–¥–µ–ª—å" class="invis">
        </div>
        <div class="form-group">
          <label>–ì–æ–¥:</label>
          <input type="number" id="year" min="1990" max="2040" placeholder="2020">
        </div>
      </div>
    </div>

    <!-- –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥ -->
    <div class="card">
      <h2 class="collapsible collapsed">üì¶ –ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≤–∫—Ä—É–≥</h2>
      <div class="card-content collapsed">
        <div class="package-grid">
          <div><label>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–ª–µ–Ω–∫–∏:</label><input type="number" id="pkgWrapMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –æ–∫–ª–µ–π—â–∏–∫–∞:</label><input type="number" id="pkgWrapMot" placeholder="0" step="0.01"></div>
          <div><label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:</label><input type="number" id="pkgPrepMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏:</label><input type="number" id="pkgPrepMot" placeholder="0" step="0.01"></div>
          <div><label>–ú–∞—Ç–µ—Ä–∏–∞–ª –∞—Ä–º–∞—Ç—É—Ä–∫–∏:</label><input type="number" id="pkgArmMat" placeholder="0" step="0.01"></div>
          <div><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è –∞—Ä–º–∞—Ç—É—Ä—â–∏–∫–∞:</label><input type="number" id="pkgArmMot" placeholder="0" step="0.01"></div>
        </div>
        <div style="margin-top:15px">
          <label class="markup-label">‚ö†Ô∏è –ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –ø–∞–∫–µ—Ç (%):</label>
          <input type="number" id="pkgMarkup" placeholder="0" step="1">
          <div class="chips">
            <span class="chip" data-markup-target="#pkgMarkup">10</span>
            <span class="chip" data-markup-target="#pkgMarkup">20</span>
            <span class="chip" data-markup-target="#pkgMarkup">30</span>
            <span class="chip" data-markup-target="#pkgMarkup">40</span>
            <span class="chip" data-markup-target="#pkgMarkup">50</span>
            <span class="chip" data-markup-target="#pkgMarkup">60</span>
            <span class="chip" data-markup-target="#pkgMarkup">70</span>
            <span class="chip" data-markup-target="#pkgMarkup">80</span>
            <span class="chip" data-markup-target="#pkgMarkup">90</span>
            <span class="chip" data-markup-target="#pkgMarkup">100</span>
          </div>
        </div>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã -->
    <div class="card">
      <h2>üí≥ –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã</h2>
      <div class="card-content">
        <div class="toggle-group">
          <label class="toggle-btn active">
            <input type="radio" name="payMode" value="cash" checked style="display:none">
            <span>üíµ –ù–∞–ª–∏—á–Ω—ã–µ (0%)</span>
          </label>
          <label class="toggle-btn">
            <input type="radio" name="payMode" value="card" style="display:none">
            <span>üí≥ –ö–∞—Ä—Ç–∞ (+8%)</span>
          </label>
          <label class="toggle-btn">
            <input type="radio" name="payMode" value="ip" style="display:none">
            <span>üë§ –ò–ü (+8%)</span>
          </label>
          <label class="toggle-btn">
            <input type="radio" name="payMode" value="ooo" style="display:none">
            <span>üè¢ –û–û–û (+20%)</span>
          </label>
        </div>
      </div>
    </div>

    <!-- –ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã -->
    <div class="card">
      <h2 class="collapsible collapsed">üîß –ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h2>
      <div class="card-content collapsed" id="armContent"></div>
    </div>

    <!-- –û–∫–ª–µ–π–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è -->
    <div class="card">
      <h2 class="collapsible collapsed">üé® –û–∫–ª–µ–π–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h2>
      <div class="card-content collapsed" id="wrapContent"></div>
    </div>

    <!-- –î–µ—Ç–µ–π–ª–∏–Ω–≥ -->
    <div class="card">
      <h2 class="collapsible collapsed">‚ú® –î–µ—Ç–µ–π–ª–∏–Ω–≥</h2>
      <div class="card-content collapsed" id="detContent"></div>
    </div>

    <!-- –°—Ç—ë–∫–ª–∞ -->
    <div class="card">
      <h2 class="collapsible collapsed">ü™ü –°—Ç—ë–∫–ª–∞</h2>
      <div class="card-content collapsed" id="glContent"></div>
    </div>

    <!-- –ü—Ä–æ—á–∏–µ —Ä–∞–±–æ—Ç—ã -->
    <div class="card">
      <h2 class="collapsible collapsed">üõ†Ô∏è –ü—Ä–æ—á–∏–µ —Ä–∞–±–æ—Ç—ã</h2>
      <div class="card-content collapsed" id="miscContent"></div>
    </div>

    <!-- –ò—Ç–æ–≥–∏ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º -->
    <div class="card">
      <h2>üìä –ò—Ç–æ–≥–∏ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º</h2>
      <div class="card-content">
        <div class="summary-cards" id="summaryContent"></div>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ö–ü -->
    <div class="card">
      <h2>üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ö–ü</h2>
      <div class="card-content">
        <div class="table-wrapper">
          <table id="kpTable">
            <thead><tr><th style="width:25%">–£—Å–ª—É–≥–∞</th><th style="width:50%">–û–ø–∏—Å–∞–Ω–∏–µ</th><th style="width:25%">–°—Ç–æ–∏–º–æ—Å—Ç—å</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="text-align:right;font-weight:bold;margin-top:10px">–ò—Ç–æ–≥–æ: <span id="kpTotal">0,00</span> ‚ÇΩ</div>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
    <div class="card">
      <h2>üí∞ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</h2>
      <div class="card-content">
        <div class="table-wrapper">
          <table id="costTable">
            <thead><tr><th style="width:50%">–£—Å–ª—É–≥–∞</th><th style="width:25%">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</th><th style="width:25%">–ú–æ—Ç–∏–≤–∞—Ü–∏—è</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="display:flex;justify-content:space-between;font-weight:bold;margin-top:10px;flex-wrap:wrap;gap:10px;font-size:.9rem">
          <span>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã: <span id="cMat">0,00</span> ‚ÇΩ</span>
          <span>–ú–æ—Ç–∏–≤–∞—Ü–∏—è: <span id="cMot">0,00</span> ‚ÇΩ</span>
          <span>–ò—Ç–æ–≥–æ: <span id="cTotal">0,00</span> ‚ÇΩ</span>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ—á–Ω—è —Ä–∞–±–æ—Ç -->
    <div class="card">
      <h2>üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–µ—á–Ω—è —Ä–∞–±–æ—Ç</h2>
      <div class="card-content">
        <div class="table-wrapper">
          <table id="workTable">
            <thead><tr><th style="width:35%">–£—Å–ª—É–≥–∞</th><th style="width:20%">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th><th style="width:15%">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</th><th style="width:15%">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th><th style="width:15%">–ü–æ–¥–ø–∏—Å—å</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT COLUMN -->
  <div class="right-column">
    
    <!-- –°–∫–∏–¥–∫–∏ -->
    <div class="card">
      <h2>üéÅ –°–∫–∏–¥–∫–∏</h2>
      <div class="card-content">
        <div class="discount-grid">
          <div class="discount-btn" data-discount="0">0%</div>
          <div class="discount-btn" data-discount="5">5%</div>
          <div class="discount-btn" data-discount="10">10%</div>
          <div class="discount-btn" data-discount="15">15%</div>
          <div class="discount-btn" data-discount="20">20%</div>
          <div class="discount-btn" data-discount="25">25%</div>
        </div>
        <div style="margin-top:8px">
          <input type="number" id="customDiscount" placeholder="–°–≤–æ—è —Å–∫–∏–¥–∫–∞ %" min="0" max="100" step="0.01">
        </div>
      </div>
    </div>

    <!-- –ò—Ç–æ–≥–∏ -->
    <div class="card">
      <h2>üíé –ò—Ç–æ–≥–∏</h2>
      <div class="card-content">
        <div class="totals-grid">
          <div class="total-item"><div class="total-label">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div><div class="total-value" id="grandMat">0,00</div></div>
          <div class="total-item"><div class="total-label">–ú–æ—Ç–∏–≤–∞—Ü–∏—è</div><div class="total-value" id="grandMot">0,00</div></div>
          <div class="total-item"><div class="total-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</div><div class="total-value" id="grandBase">0,00</div></div>
          <div class="total-item"><div class="total-label">–ù–∞—Ü–µ–Ω–∫–∞</div><div class="total-value" id="grandMarkup">0,00</div></div>
          <div class="total-item"><div class="total-label">–ù–∞–ª–æ–≥</div><div class="total-value" id="grandTax">0,00</div></div>
          <div class="total-item final-total"><div class="total-label">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</div><div class="total-value" id="finalTotal">0,00</div></div>
        </div>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
    <div class="card">
      <h2>üì• –≠–∫—Å–ø–æ—Ä—Ç</h2>
      <div class="card-content">
        <div id="telegramWarning">
          ‚ö†Ô∏è <b>Telegram WebView:</b> –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (‚Ä¢‚Ä¢‚Ä¢ ‚Üí –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
          <button type="button" class="btn btn-primary" id="btnRecalc2" style="flex:1;min-width:140px">üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
          <button type="button" class="btn btn-secondary" id="btnReset2" style="flex:1;min-width:140px">üîÉ –°–±—Ä–æ—Å</button>
        </div>
        <div class="export-buttons">
          <button type="button" class="btn btn-success" id="btnExportKP">üìÑ –ö–ü (PDF)</button>
          <button type="button" class="btn btn-success" id="btnExportCost">üí∞ –°–µ–±–µ—Å (PDF)</button>
          <button type="button" class="btn btn-success" id="btnExportWork">üìã –ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç (PDF)</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PDF Templates -->
<div id="pdfTemplates">
  <div id="pdfKP" class="pdf-block">
    <h1>–ö–û–ú–ú–ï–†–ß–ï–°–ö–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï</h1>
    <p id="pdfKPMeta" style="text-align:center;margin-bottom:20px"></p>
    <table>
      <thead><tr><th style="width:25%">–£—Å–ª—É–≥–∞</th><th style="width:50%">–û–ø–∏—Å–∞–Ω–∏–µ</th><th style="width:25%">–°—Ç–æ–∏–º–æ—Å—Ç—å</th></tr></thead>
      <tbody id="pdfKPTBody"></tbody>
      <tfoot><tr><th colspan="2">–ò–¢–û–ì–û:</th><th id="pdfKPTotal"></th></tr></tfoot>
    </table>
    <p style="text-align:center;margin-top:20px;font-style:italic">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 3—Ö –¥–Ω–µ–π</p>
  </div>
  
  <div id="pdfCost" class="pdf-block">
    <h1>–°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–¨</h1>
    <p id="pdfCostMeta" style="text-align:center;margin-bottom:20px"></p>
    <table>
      <thead><tr><th>–£—Å–ª—É–≥–∞</th><th>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</th><th>–ú–æ—Ç–∏–≤–∞—Ü–∏—è</th></tr></thead>
      <tbody id="pdfCostTBody"></tbody>
      <tfoot><tr><th>–ò–¢–û–ì–û:</th><th id="pdfCM"></th><th id="pdfCO"></th></tr></tfoot>
    </table>
  </div>
  
  <div id="pdfWork" class="pdf-block">
    <h1>–ü–ï–†–ï–ß–ï–ù–¨ –†–ê–ë–û–¢</h1>
    <p id="pdfWorkMeta" style="text-align:center;margin-bottom:20px"></p>
    <table style="font-size:11px">
      <thead><tr><th style="width:35%">–£—Å–ª—É–≥–∞</th><th style="width:20%">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th><th style="width:15%">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</th><th style="width:15%">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th><th style="width:15%">–ü–æ–¥–ø–∏—Å—å</th></tr></thead>
      <tbody id="pdfWorkTBody"></tbody>
    </table>
  </div>
</div>

</div>

<script>
(function() {
'use strict';

const q = s => document.querySelector(s);
const qa = s => document.querySelectorAll(s);
const fmt = n => parseFloat((n || 0).toFixed(2)).toLocaleString('ru-RU', {
  minimumFractionDigits: 2,
  maximumFractionDigits: 2
});
const r100 = n => Math.round((n || 0) * 100) / 100;

let disc = 0;
let chart = null;

// Car Database
const carDB = {
  Audi: ["A3", "A4", "A5", "A6", "Q3", "Q5", "Q7", "Q8"],
  BMW: ["1 Series", "3 Series", "5 Series", "7 Series", "X3", "X5"],
  BYD: ["Dolphin", "Han", "Qin Plus", "Seal", "Song Plus", "Tang", "Yuan Plus"],
  Changan: ["CS35 Plus", "CS55 Plus", "CS75 Plus", "Uni-K", "Uni-T"],
  Chery: ["Arrizo 5", "Tiggo 2", "Tiggo 4", "Tiggo 7", "Tiggo 8"],
  Ford: ["Explorer", "F-150", "Fiesta", "Focus", "Mustang"],
  Geely: ["Atlas", "Coolray", "Emgrand", "Monjaro", "Tugella"],
  Haval: ["Dargo", "F7", "F7x", "H6", "H9", "Jolion"],
  Honda: ["Accord", "Civic", "CR-V", "Fit", "HR-V"],
  Hyundai: ["Creta", "Elantra", "Santa Fe", "Sonata", "Tucson"],
  Kia: ["Cerato", "Ceed", "Rio", "Seltos", "Sorento", "Sportage"],
  Lixiang: ["I8", "L6", "L7", "L8", "L9", "Mega", "One"],
  Mazda: ["CX-3", "CX-30", "CX-5", "Mazda3", "Mazda6"],
  "Mercedes-Benz": ["A-Class", "C-Class", "E-Class", "GLC", "GLE", "S-Class"],
  Nissan: ["Altima", "Qashqai", "Rogue", "Sentra", "X-Trail"],
  Omoda: ["C5", "C7", "C9", "E5", "S5"],
  Tank: ["300", "400", "500", "700"],
  Tesla: ["Model 3", "Model S", "Model X", "Model Y"],
  Toyota: ["Camry", "Corolla", "Hilux", "Land Cruiser 300", "RAV4", "Yaris"],
  Volkswagen: ["Arteon", "Golf", "Passat", "Polo", "T-Roc", "Tiguan"],
  Voyah: ["Courage", "Dream", "Free", "Passion"],
  Zeekr: ["001", "007", "009", "7X", "9X", "Mix", "X"]
};

// Partial Elements
const partElements = [
  '–ü–µ—Ä–µ–¥–Ω–∏–π –±–∞–º–ø–µ—Ä', '–ó–∞–¥–Ω–∏–π –±–∞–º–ø–µ—Ä', '–ü–µ—Ä–µ–¥–Ω–∏–π –±–∞–º–ø–µ—Ä (–¥–æ–ø)', '–ó–∞–¥–Ω–∏–π –±–∞–º–ø–µ—Ä (–¥–æ–ø)',
  '–ü–µ—Ä–µ–¥–Ω—è—è –æ–ø—Ç–∏–∫–∞', '–ü—Ä–æ—Ç–∏–≤–æ—Ç—É–º–∞–Ω–Ω—ã–µ —Ñ–∞—Ä—ã', '–ó–∞–¥–Ω–∏–µ —Ñ–æ–Ω–∞—Ä–∏', '–†–µ—à–µ—Ç–∫–∞ —Ä–∞–¥–∏–∞—Ç–æ—Ä–∞',
  '–ü–æ–ª–æ—Å–∫–∞ –Ω–∞ –∫–∞–ø–æ—Ç', '–ö–∞–ø–æ—Ç', '–ü–µ—Ä–µ–¥–Ω–µ–µ –∫—Ä—ã–ª–æ', '–î–≤–∞ –ø–µ—Ä–µ–¥–Ω–∏—Ö –∫—Ä—ã–ª–∞',
  '–†–∞—Å—à–∏—Ä–∏—Ç–µ–ª–∏ –∞—Ä–æ–∫', '–°—Ç–æ–π–∫–∏ –≤–æ–∫—Ä—É–≥ –ª–æ–±–æ–≤–æ–≥–æ', '–ü–æ–ª–æ—Å–∫–∞ –Ω–∞ –∫—Ä—ã—à—É', '–ö—Ä—ã—à–∞',
  '–ü–æ—Ä–æ–≥–∏', '–ü–æ—Ä–æ–≥–∏ –¥–æ –∑–∞–º–∫–∞', '–î–≤–µ—Ä–Ω—ã–µ –ø—Ä–æ–µ–º—ã', '–ü–µ—Ä–µ–¥–Ω—è—è –¥–≤–µ—Ä—å',
  '–ü–µ—Ä–µ–¥–Ω–∏–µ –¥–≤–µ—Ä–∏ (2 —à—Ç)', '–ó–æ–Ω–∞ –ø–æ–¥ —Ä—É—á–∫–∞–º–∏ (2 —à—Ç)', '–ó–æ–Ω–∞ –ø–æ–¥ —Ä—É—á–∫–∞–º–∏ (4 —à—Ç)',
  '–ó–∞–¥–Ω—è—è –¥–≤–µ—Ä—å', '–ó–∞–¥–Ω–∏–µ –¥–≤–µ—Ä–∏ (2 —à—Ç)', '–ó–∞–¥–Ω–µ–µ –∫—Ä—ã–ª–æ', '–ó–∞–¥–Ω–∏–µ –∫—Ä—ã–ª—å—è (2 —à—Ç)',
  '–ö—Ä—ã—à–∫–∞ –±–∞–≥–∞–∂–Ω–∏–∫–∞', '–ë–∞–≥–∞–∂–Ω–∏–∫ (–¥–æ–ø)', '–û–∫–ª–µ–π–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞', '–ê–Ω—Ç–∏—Ö—Ä–æ–º'
];

// Service Lists
const armServices = ['–î–µ–º–æ–Ω—Ç–∞–∂ —ç–ª–µ–º–µ–Ω—Ç–æ–≤', '–ú–æ–Ω—Ç–∞–∂ —ç–ª–µ–º–µ–Ω—Ç–æ–≤', '–î–µ–º–æ–Ω—Ç–∞–∂ –∏ –º–æ–Ω—Ç–∞–∂'];
const detailServices = [
  '–ú–æ–π–∫–∞ –∫—É–∑–æ–≤–∞ –ø–µ—Ä–µ–¥ –æ–∫–ª–µ–π–∫–æ–π', '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—É–∑–æ–≤–∞', '–ì–ª—É–±–æ–∫–∞—è —á–∏—Å—Ç–∫–∞ –∫—É–∑–æ–≤–∞',
  '–ü–æ–ª–∏—Ä–æ–≤–∫–∞ –∫—É–∑–æ–≤–∞', '–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–æ–≤ –Ω–∞ –∫—É–∑–æ–≤', '–•–∏–º—á–∏—Å—Ç–∫–∞ —Å–∞–ª–æ–Ω–∞',
  '–ù–∞–Ω–µ—Å–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–æ–≤ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–∞–ª–æ–Ω–∞', '–ü–æ–ª–∏—Ä–æ–≤–∫–∞ –≥–ª—è–Ω—Ü–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤'
];
const glassServices = [
  '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–Ω–µ–π –ø–æ–ª—É—Å—Ñ–µ—Ä—ã', '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥–Ω–∏—Ö –±–æ–∫–æ–≤—ã—Ö —Å—Ç–µ–∫–æ–ª',
  '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞', '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–±–æ–≤–æ–≥–æ —Å—Ç–µ–∫–ª–∞'
];
const miscServices = [
  '–ú–∞–ª—è—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', '–í—ã–ø—Ä—è–º–ª–µ–Ω–∏–µ –≤–º—è—Ç–∏–Ω –±–µ–∑ –ø–æ–∫—Ä–∞—Å–∫–∏',
  '–†–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è –õ–ö–ü', '–®—É–º–æ–∏–∑–æ–ª—è—Ü–∏—è'
];

// Theme Toggle
window.toggleTheme = function() {
  const body = document.body;
  const icon = q('#themeIcon');
  const currentTheme = body.getAttribute('data-theme');
  
  if (currentTheme === 'light') {
    body.removeAttribute('data-theme');
    icon.textContent = '‚òÄÔ∏è';
    localStorage.setItem('theme', 'dark');
  } else {
    body.setAttribute('data-theme', 'light');
    icon.textContent = 'üåô';
    localStorage.setItem('theme', 'light');
  }
};

// Fill Brands
function fillBrands() {
  const s = q('#brand');
  s.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option><option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>';
  Object.keys(carDB).sort().forEach(b => {
    const o = document.createElement('option');
    o.value = b;
    o.textContent = b;
    s.appendChild(o);
  });
}

// Brand Change
function onBrandChange() {
  const b = q('#brand').value;
  const m = q('#model');
  const bm = q('#brandManual');
  m.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option><option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>';
  
  if (b && carDB[b]) {
    bm.classList.add('invis');
    carDB[b].forEach(md => {
      const o = document.createElement('option');
      o.value = md;
      o.textContent = md;
      m.appendChild(o);
    });
  } else if (b === 'manual') {
    bm.classList.remove('invis');
    m.innerHTML = '<option value="manual">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>';
  }
}

// Model Change
function onModelChange() {
  const m = q('#model').value;
  const mm = q('#modelManual');
  if (m === 'manual') mm.classList.remove('invis');
  else mm.classList.add('invis');
}

// Render Service List
function renderServiceList(containerId, services, classPrefix) {
  const container = q(containerId);
  let html = '';
  
  services.forEach((name, idx) => {
    html += `<div class="service-item">
      <div class="service-header">
        <input type="checkbox" class="${classPrefix}-chk" id="${classPrefix}${idx + 1}">
        <label for="${classPrefix}${idx + 1}">${name}</label>
      </div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã (‚ÇΩ):</label><input type="number" class="${classPrefix}-mat" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è (‚ÇΩ):</label><input type="number" class="${classPrefix}-mot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity">
          <input type="checkbox" class="${classPrefix}-complex" id="${classPrefix}${idx + 1}c">
          <label for="${classPrefix}${idx + 1}c">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label>
        </div>
      </div>
    </div>`;
  });
  
  html += `<div id="${classPrefix}Dyn"></div>
    <button type="button" class="btn btn-secondary" id="btnAdd${classPrefix.charAt(0).toUpperCase() + classPrefix.slice(1)}">+ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</button>
    <div style="margin-top:15px">
      <label class="markup-label">–ù–∞—Ü–µ–Ω–∫–∞ (%):</label>
      <input type="number" id="${classPrefix}Markup" placeholder="0" step="1">
      <div class="chips">
        <span class="chip" data-markup-target="#${classPrefix}Markup">10</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">20</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">30</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">40</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">50</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">60</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">70</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">80</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">90</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">100</span>
      </div>
    </div>`;
  
  container.innerHTML = html;
}

// Render Wrap Content
function renderWrapContent() {
  const container = q('#wrapContent');
  let html = `<h3 style="margin-bottom:10px;font-size:1.05rem;font-weight:700">PPF</h3>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfClearChk"><label for="ppfClearChk">PPF –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≤–∫—Ä—É–≥</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" id="ppfClearM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä (‚ÇΩ):</label><input type="number" id="ppfClearPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è (‚ÇΩ):</label><input type="number" id="ppfClearMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfClearComplex"><label for="ppfClearComplex">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfColorChk"><label for="ppfColorChk">PPF —Ü–≤–µ—Ç–Ω–æ–π –≤–∫—Ä—É–≥</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" id="ppfColorM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä (‚ÇΩ):</label><input type="number" id="ppfColorPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è (‚ÇΩ):</label><input type="number" id="ppfColorMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfColorComplex"><label for="ppfColorComplex">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfMatChk"><label for="ppfMatChk">PPF –º–∞—Ç–æ–≤—ã–π –≤–∫—Ä—É–≥</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" id="ppfMatM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä (‚ÇΩ):</label><input type="number" id="ppfMatPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è (‚ÇΩ):</label><input type="number" id="ppfMatMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfMatComplex"><label for="ppfMatComplex">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>
    <div class="partial-wrapper">
      <div class="partial-header"><input type="checkbox" id="ppfPartChk"><label for="ppfPartChk">PPF —á–∞—Å—Ç–∏—á–Ω–æ</label></div>
      <div class="partial-content" id="ppfPartContent"></div>
    </div>
    <h3 style="margin:20px 0 10px;font-size:1.05rem;font-weight:700">PVC</h3>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="pvcFullChk"><label for="pvcFullChk">–ü–í–• –ø–æ–ª–Ω–∞—è –æ–∫–ª–µ–π–∫–∞</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" id="pvcFullM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä (‚ÇΩ):</label><input type="number" id="pvcFullPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è (‚ÇΩ):</label><input type="number" id="pvcFullMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="pvcFullComplex"><label for="pvcFullComplex">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>
    <div class="partial-wrapper">
      <div class="partial-header"><input type="checkbox" id="pvcPartChk"><label for="pvcPartChk">–ü–í–• —á–∞—Å—Ç–∏—á–Ω–æ</label></div>
      <div class="partial-content" id="pvcPartContent"></div>
    </div>
    <div id="wrapDyn"></div>
    <button type="button" class="btn btn-secondary" id="btnAddWrap">+ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</button>
    <div style="margin-top:20px">
      <label class="markup-label">‚ö†Ô∏è –ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ –æ–∫–ª–µ–π–∫—É (%):</label>
      <input type="number" id="wrapMarkup" placeholder="0" step="1">
      <div class="chips">
        <span class="chip" data-markup-target="#wrapMarkup">10</span>
        <span class="chip" data-markup-target="#wrapMarkup">20</span>
        <span class="chip" data-markup-target="#wrapMarkup">30</span>
        <span class="chip" data-markup-target="#wrapMarkup">40</span>
        <span class="chip" data-markup-target="#wrapMarkup">50</span>
        <span class="chip" data-markup-target="#wrapMarkup">60</span>
        <span class="chip" data-markup-target="#wrapMarkup">70</span>
        <span class="chip" data-markup-target="#wrapMarkup">80</span>
        <span class="chip" data-markup-target="#wrapMarkup">90</span>
        <span class="chip" data-markup-target="#wrapMarkup">100</span>
      </div>
    </div>`;
  
  container.innerHTML = html;
}

// Render Partial Lists
function renderPartialLists() {
  const ppf = q('#ppfPartContent');
  const pvc = q('#pvcPartContent');
  let ppfHtml = '', pvcHtml = '';
  
  partElements.forEach((name, idx) => {
    ppfHtml += `<div class="service-item">
      <div class="service-header"><input type="checkbox" class="ppf-part-chk" id="ppfp${idx}"><label for="ppfp${idx}">${name}</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" class="ppf-part-m" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä (‚ÇΩ):</label><input type="number" class="ppf-part-price" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è (‚ÇΩ):</label><input type="number" class="ppf-part-mot" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–°–≤–æ—è –Ω–∞—Ü–µ–Ω–∫–∞ (%):</label><input type="number" class="ppf-part-markup" placeholder="0"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" class="ppf-part-complex" id="ppfp${idx}c"><label for="ppfp${idx}c">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>`;
    
    pvcHtml += `<div class="service-item">
      <div class="service-header"><input type="checkbox" class="pvc-part-chk" id="pvcp${idx}"><label for="pvcp${idx}">${name}</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>–ú–µ—Ç—Ä—ã (–º):</label><input type="number" class="pvc-part-m" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä (‚ÇΩ):</label><input type="number" class="pvc-part-price" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è (‚ÇΩ):</label><input type="number" class="pvc-part-mot" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>–°–≤–æ—è –Ω–∞—Ü–µ–Ω–∫–∞ (%):</label><input type="number" class="pvc-part-markup" placeholder="0"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" class="pvc-part-complex" id="pvcp${idx}c"><label for="pvcp${idx}c">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label></div>
      </div>
    </div>`;
  });
  
  ppf.innerHTML = ppfHtml;
  pvc.innerHTML = pvcHtml;
}

// Render Summary Cards
function renderSummaryCards() {
  const container = q('#summaryContent');
  const sections = [
    { id: 'Pkg', label: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞' },
    { id: 'Arm', label: '–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ' },
    { id: 'Wrap', label: '–û–∫–ª–µ–π–∫–∞' },
    { id: 'Det', label: '–î–µ—Ç–µ–π–ª–∏–Ω–≥' },
    { id: 'Gl', label: '–°—Ç—ë–∫–ª–∞' },
    { id: 'Misc', label: '–ü—Ä–æ—á–∏–µ' }
  ];
  
  let html = '';
  sections.forEach(s => {
    html += `<div class="service-item" id="sum${s.id}Card">
      <div class="service-header"><label style="flex:1">${s.label}</label></div>
      <div class="service-fields" style="display:grid">
        <div class="form-group"><label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</label><input type="number" id="sum${s.id}Mat" readonly step="0.01"></div>
        <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è:</label><input type="number" id="sum${s.id}Mot" readonly step="0.01"></div>
        <div class="form-group"><label>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:</label><input type="number" id="seb${s.id}" readonly step="0.01"></div>
      </div>
    </div>`;
  });
  
  container.innerHTML = html;
}

// Add Dynamic Row
let dynCounter = 0;
function addDynRow(id, cls) {
  const c = q(id);
  const d = document.createElement('div');
  d.className = 'service-item';
  dynCounter++;
  d.innerHTML = `<div class="service-header">
    <input type="checkbox" checked id="dyn${cls}${dynCounter}">
    <label for="dyn${cls}${dynCounter}"><input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" style="border:none;background:transparent;padding:0;font-weight:600;font-size:.95rem;color:var(--text);width:100%"></label>
  </div>
  <div class="service-body open">
    <div class="service-fields">
      <div class="form-group"><label>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã (‚ÇΩ):</label><input type="number" class="${cls}-mat" placeholder="0" step="0.01"></div>
      <div class="form-group"><label>–ú–æ—Ç–∏–≤–∞—Ü–∏—è (‚ÇΩ):</label><input type="number" class="${cls}-mot" placeholder="0" step="0.01"></div>
    </div>
    <div class="service-complexity">
      <input type="checkbox" class="${cls}-complex" id="dyn${cls}${dynCounter}c">
      <label for="dyn${cls}${dynCounter}c">–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ +10%</label>
    </div>
  </div>`;
  c.appendChild(d);
}

// Init Service Toggles
function initServiceToggles() {
  qa('.service-item').forEach(item => {
    const chk = item.querySelector('.service-header input[type="checkbox"]');
    const body = item.querySelector('.service-body');
    const header = item.querySelector('.service-header');
    
    if (!chk || !body) return;
    
    header.onclick = function(e) {
      if (e.target === chk || e.target.tagName === 'INPUT') return;
      chk.click();
    };
    
    chk.onchange = function() {
      if (chk.checked) {
        body.classList.add('open');
      } else {
        body.classList.remove('open');
      }
    };
  });
  
  // PPF/PVC Partial toggles
  const ppfPartChk = q('#ppfPartChk');
  const ppfPartContent = q('#ppfPartContent');
  if (ppfPartChk && ppfPartContent) {
    ppfPartChk.onchange = function() {
      if (ppfPartChk.checked) {
        ppfPartContent.classList.add('open');
      } else {
        ppfPartContent.classList.remove('open');
      }
    };
  }
  
  const pvcPartChk = q('#pvcPartChk');
  const pvcPartContent = q('#pvcPartContent');
  if (pvcPartChk && pvcPartContent) {
    pvcPartChk.onchange = function() {
      if (pvcPartChk.checked) {
        pvcPartContent.classList.add('open');
      } else {
        pvcPartContent.classList.remove('open');
      }
    };
  }
}

// [–ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –í –°–õ–ï–î–£–Æ–©–ï–ú –°–û–û–ë–©–ï–ù–ò–ò - –§–ê–ô–õ –°–õ–ò–®–ö–û–ú –ë–û–õ–¨–®–û–ô]

// Collect All Data
function collectAll() {
  const sums = {
    pkg: { mat: 0, mot: 0, names: [] },
    arm: { mat: 0, mot: 0, names: [] },
    wrap: { mat: 0, mot: 0, details: [] },
    det: { mat: 0, mot: 0, names: [] },
    gl: { mat: 0, mot: 0, names: [] },
    ms: { mat: 0, mot: 0, names: [] }
  };
  
  // Package
  const pkgWrapMat = parseFloat(q('#pkgWrapMat')?.value) || 0;
  const pkgWrapMot = parseFloat(q('#pkgWrapMot')?.value) || 0;
  const pkgPrepMat = parseFloat(q('#pkgPrepMat')?.value) || 0;
  const pkgPrepMot = parseFloat(q('#pkgPrepMot')?.value) || 0;
  const pkgArmMat = parseFloat(q('#pkgArmMat')?.value) || 0;
  const pkgArmMot = parseFloat(q('#pkgArmMot')?.value) || 0;
  
  if (pkgWrapMat > 0 || pkgWrapMot > 0 || pkgPrepMat > 0 || pkgPrepMot > 0 || pkgArmMat > 0 || pkgArmMot > 0) {
    sums.pkg.mat = pkgWrapMat + pkgPrepMat + pkgArmMat;
    sums.pkg.mot = pkgWrapMot + pkgPrepMot + pkgArmMot;
    sums.pkg.names.push('–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞');
  }
  
  // Arm
  qa('.arm-chk').forEach(c => {
    if (c.checked) {
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let mat = parseFloat(item.querySelector('.arm-mat')?.value) || 0;
      let mot = parseFloat(item.querySelector('.arm-mot')?.value) || 0;
      if (item.querySelector('.arm-complex')?.checked) { mat *= 1.1; mot *= 1.1; }
      if (n && (mat > 0 || mot > 0)) {
        sums.arm.mat += mat;
        sums.arm.mot += mot;
        sums.arm.names.push(n);
      }
    }
  });
  
  qa('#armDyn .service-item').forEach(item => {
    const c = item.querySelector('input[type=checkbox]');
    if (c?.checked) {
      const n = item.querySelector('input[type=text]')?.value?.trim() || '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏';
      let mat = parseFloat(item.querySelector('.arm-mat')?.value) || 0;
      let mot = parseFloat(item.querySelector('.arm-mot')?.value) || 0;
      if (item.querySelector('.arm-complex')?.checked) { mat *= 1.1; mot *= 1.1; }
      if (mat > 0 || mot > 0) {
        sums.arm.mat += mat;
        sums.arm.mot += mot;
        sums.arm.names.push(n);
      }
    }
  });
  
  // Wrap - PPF Clear
  if (q('#ppfClearChk')?.checked) {
    const pr = parseFloat(q('#ppfClearPrice')?.value) || 0;
    let m = parseFloat(q('#ppfClearM')?.value) || 0;
    let mot = parseFloat(q('#ppfClearMot')?.value) || 0;
    if (q('#ppfClearComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≤–∫—Ä—É–≥', m, pr, mat, mot, 0]);
  }
  
  // PPF Color
  if (q('#ppfColorChk')?.checked) {
    const pr = parseFloat(q('#ppfColorPrice')?.value) || 0;
    let m = parseFloat(q('#ppfColorM')?.value) || 0;
    let mot = parseFloat(q('#ppfColorMot')?.value) || 0;
    if (q('#ppfColorComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF —Ü–≤–µ—Ç–Ω–æ–π –≤–∫—Ä—É–≥', m, pr, mat, mot, 0]);
  }
  
  // PPF Mat
  if (q('#ppfMatChk')?.checked) {
    const pr = parseFloat(q('#ppfMatPrice')?.value) || 0;
    let m = parseFloat(q('#ppfMatM')?.value) || 0;
    let mot = parseFloat(q('#ppfMatMot')?.value) || 0;
    if (q('#ppfMatComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF –º–∞—Ç–æ–≤—ã–π –≤–∫—Ä—É–≥', m, pr, mat, mot, 0]);
  }
  
  // PPF Partial
  qa('.ppf-part-chk').forEach(c => {
    if (c.checked) {
      const ppfPartMainChk = q('#ppfPartChk');
      if (!ppfPartMainChk || !ppfPartMainChk.checked) return;
      
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let m = parseFloat(item.querySelector('.ppf-part-m')?.value) || 0;
      const pr = parseFloat(item.querySelector('.ppf-part-price')?.value) || 0;
      let mot = parseFloat(item.querySelector('.ppf-part-mot')?.value) || 0;
      if (item.querySelector('.ppf-part-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        const itemMarkup = parseFloat(item.querySelector('.ppf-part-markup')?.value) || 0;
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([`PPF —á–∞—Å—Ç–∏—á–Ω–æ - ${n}`, m, pr, mat, mot, itemMarkup]);
      }
    }
  });
  
  // PVC Full
  if (q('#pvcFullChk')?.checked) {
    const pr = parseFloat(q('#pvcFullPrice')?.value) || 0;
    let m = parseFloat(q('#pvcFullM')?.value) || 0;
    let mot = parseFloat(q('#pvcFullMot')?.value) || 0;
    if (q('#pvcFullComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['–ü–í–• –ø–æ–ª–Ω–∞—è –æ–∫–ª–µ–π–∫–∞', m, pr, mat, mot, 0]);
  }
  
  // PVC Partial
  qa('.pvc-part-chk').forEach(c => {
    if (c.checked) {
      const pvcPartMainChk = q('#pvcPartChk');
      if (!pvcPartMainChk || !pvcPartMainChk.checked) return;
      
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let m = parseFloat(item.querySelector('.pvc-part-m')?.value) || 0;
      const pr = parseFloat(item.querySelector('.pvc-part-price')?.value) || 0;
      let mot = parseFloat(item.querySelector('.pvc-part-mot')?.value) || 0;
      if (item.querySelector('.pvc-part-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        const itemMarkup = parseFloat(item.querySelector('.pvc-part-markup')?.value) || 0;
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([`–ü–í–• —á–∞—Å—Ç–∏—á–Ω–æ - ${n}`, m, pr, mat, mot, itemMarkup]);
      }
    }
  });
  
  // Wrap Dynamic
  qa('#wrapDyn .service-item').forEach(item => {
    const c = item.querySelector('input[type=checkbox]');
    if (c?.checked) {
      const n = item.querySelector('input[type=text]')?.value?.trim() || '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏';
      let m = parseFloat(item.querySelectorAll('input[type=number]')[0]?.value) || 0;
      const pr = parseFloat(item.querySelectorAll('input[type=number]')[1]?.value) || 0;
      let mot = parseFloat(item.querySelectorAll('input[type=number]')[2]?.value) || 0;
      if (item.querySelector('.wrap-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([n, m, pr, mat, mot, 0]);
      }
    }
  });
  
  // Det, Gl, Misc
  ['det', 'gl', 'misc'].forEach(tp => {
    const key = tp === 'misc' ? 'ms' : tp;
    
    qa(`.${tp}-chk`).forEach(c => {
      if (c.checked) {
        const item = c.closest('.service-item');
        const n = item.querySelector('.service-header label')?.textContent?.trim();
        let mat = parseFloat(item.querySelector(`.${tp}-mat`)?.value) || 0;
        let mot = parseFloat(item.querySelector(`.${tp}-mot`)?.value) || 0;
        if (item.querySelector(`.${tp}-complex`)?.checked) { mat *= 1.1; mot *= 1.1; }
        if (n && (mat > 0 || mot > 0)) {
          sums[key].mat += mat;
          sums[key].mot += mot;
          sums[key].names.push(n);
        }
      }
    });
    
    qa(`#${tp}Dyn .service-item`).forEach(item => {
      const c = item.querySelector('input[type=checkbox]');
      if (c?.checked) {
        const n = item.querySelector('input[type=text]')?.value?.trim() || '–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏';
        let mat = parseFloat(item.querySelector(`.${tp}-mat`)?.value) || 0;
        let mot = parseFloat(item.querySelector(`.${tp}-mot`)?.value) || 0;
        if (item.querySelector(`.${tp}-complex`)?.checked) { mat *= 1.1; mot *= 1.1; }
        if (mat > 0 || mot > 0) {
          sums[key].mat += mat;
          sums[key].mot += mot;
          sums[key].names.push(n);
        }
      }
    });
  });
  
  return sums;
}

// Tax Coefficient
function taxCoef() {
  const m = q('input[name=payMode]:checked')?.value;
  return m === 'card' ? 0.08 : m === 'ip' ? 0.08 : m === 'ooo' ? 0.20 : 0;
}

// Markups
function markups() {
  return {
    pkg: parseFloat(q('#pkgMarkup')?.value) || 0,
    arm: parseFloat(q('#armMarkup')?.value) || 0,
    wrap: parseFloat(q('#wrapMarkup')?.value) || 0,
    det: parseFloat(q('#detMarkup')?.value) || 0,
    gl: parseFloat(q('#glMarkup')?.value) || 0,
    ms: parseFloat(q('#miscMarkup')?.value) || 0
  };
}

// Render KP
function renderKP(s, mu) {
  const tb = q('#kpTable tbody');
  if (!tb) return;
  tb.innerHTML = '';
  
  const taxK = taxCoef();
  let tot = 0;
  
  const rows = [
    { t: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞', det: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≥–ª—è–Ω—Ü–µ–≤—ã—Ö –∫—É–∑–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —Ä–∞–∑–±–æ—Ä–æ–º —Å—ä–µ–º–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –∫—É–∑–æ–≤–∞', sum: s.pkg, mu: mu.pkg },
    { t: '–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ', det: '–î–µ–º–æ–Ω—Ç–∞–∂ –∏ –º–æ–Ω—Ç–∞–∂ —Å—ä–µ–º–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫—É–∑–æ–≤–∞', sum: s.arm, mu: mu.arm },
    { t: '–î–µ—Ç–µ–π–ª–∏–Ω–≥', det: '–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —á–∏—Å—Ç–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—É–∑–æ–≤–∞ –∏ —Å–∞–ª–æ–Ω–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è', sum: s.det, mu: mu.det },
    { t: '–°—Ç—ë–∫–ª–∞', det: '–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞—â–∏—Ç–∞ —Å—Ç–µ–∫–æ–ª –∞–≤—Ç–æ–º–æ–±–∏–ª—è', sum: s.gl, mu: mu.gl },
    { t: '–ü—Ä–æ—á–∏–µ', det: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –ø–æ –∫—É–∑–æ–≤—É –∞–≤—Ç–æ–º–æ–±–∏–ª—è', sum: s.ms, mu: mu.ms }
  ];
  
  rows.forEach(r => {
    const base = r.sum.mat + r.sum.mot;
    if (base <= 0) return;
    
    const markupAmount = r100(base * (r.mu || 0) / 100);
    const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
    let pr = base + markupWithDiscount;
    pr = r100(pr * (1 + taxK));
    tot += pr;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${r.t}</td><td style="text-align:left">${r.det || '‚Äî'}</td><td>${fmt(pr)}</td>`;
    tb.appendChild(tr);
  });
  
  // Wrap details
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      const base = mat + mot;
      if (base <= 0) return;
      
      const markupToUse = (itemMarkup && itemMarkup > 0) ? itemMarkup : mu.wrap;
      const markupAmount = r100(base * (markupToUse || 0) / 100);
      const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
      let pr = base + markupWithDiscount;
      pr = r100(pr * (1 + taxK));
      tot += pr;
      
      const tr = document.createElement('tr');
      const displayName = name.includes('PPF') || name.includes('–ü–í–•') ? '–û–∫–ª–µ–π–∫–∞' : '–û–∫–ª–µ–π–∫–∞';
      const displayDesc = name.includes('–≤–∫—Ä—É–≥') ? '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞ –≥–ª—è–Ω—Ü–µ–≤—ã—Ö –∫—É–∑–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–º–æ–±–∏–ª—è' : name;
      tr.innerHTML = `<td style="text-align:left">${displayName}</td><td style="text-align:left">${displayDesc}</td><td>${fmt(pr)}</td>`;
      tb.appendChild(tr);
    });
  }
  
  q('#kpTotal').textContent = fmt(tot);
}

// Render Cost
function renderCost(s) {
  const tb = q('#costTable tbody');
  if (!tb) return;
  tb.innerHTML = '';
  
  const rows = [
    { t: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞', sum: s.pkg },
    { t: '–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ', sum: s.arm },
    { t: '–î–µ—Ç–µ–π–ª–∏–Ω–≥', sum: s.det },
    { t: '–°—Ç—ë–∫–ª–∞', sum: s.gl },
    { t: '–ü—Ä–æ—á–∏–µ', sum: s.ms }
  ];
  
  let totM = 0, totO = 0;
  
  rows.forEach(r => {
    const base = r.sum.mat + r.sum.mot;
    if (base <= 0) return;
    
    totM += r.sum.mat;
    totO += r.sum.mot;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${r.t}</td><td>${fmt(r.sum.mat)}</td><td>${fmt(r.sum.mot)}</td>`;
    tb.appendChild(tr);
  });
  
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      if (mat <= 0 && mot <= 0) return;
      
      totM += mat;
      totO += mot;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left">${name}</td><td>${fmt(mat)}</td><td>${fmt(mot)}</td>`;
      tb.appendChild(tr);
    });
  }
  
  q('#cMat').textContent = fmt(totM);
  q('#cMot').textContent = fmt(totO);
  q('#cTotal').textContent = fmt(totM + totO);
}

// Render Work
function renderWork(s) {
  const tb = q('#workTable tbody');
  if (!tb) return;
  tb.innerHTML = '';
  
  const rows = [
    { t: '–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞', sum: s.pkg },
    { t: '–ê—Ä–º–∞—Ç—É—Ä–Ω—ã–µ', sum: s.arm },
    { t: '–î–µ—Ç–µ–π–ª–∏–Ω–≥', sum: s.det },
    { t: '–°—Ç—ë–∫–ª–∞', sum: s.gl },
    { t: '–ü—Ä–æ—á–∏–µ', sum: s.ms }
  ];
  
  rows.forEach(r => {
    const base = r.sum.mat + r.sum.mot;
    if (base <= 0) return;
    
    const tr1 = document.createElement('tr');
    tr1.innerHTML = `<td style="text-align:left" rowspan="2">${r.t}</td><td>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å 1</td><td></td><td></td><td></td>`;
    tb.appendChild(tr1);
    
    const tr2 = document.createElement('tr');
    tr2.innerHTML = `<td>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å 2</td><td></td><td></td><td></td>`;
    tb.appendChild(tr2);
  });
  
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      if (mat <= 0 && mot <= 0) return;
      
      const tr1 = document.createElement('tr');
      tr1.innerHTML = `<td style="text-align:left" rowspan="2">${name}</td><td>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å 1</td><td></td><td></td><td></td>`;
      tb.appendChild(tr1);
      
      const tr2 = document.createElement('tr');
      tr2.innerHTML = `<td>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å 2</td><td></td><td></td><td></td>`;
      tb.appendChild(tr2);
    });
  }
}

// Render Badges
function renderBadges(s, mu) {
  q('#sumPkgMat').value = s.pkg.mat.toFixed(2);
  q('#sumPkgMot').value = s.pkg.mot.toFixed(2);
  q('#sebPkg').value = (s.pkg.mat + s.pkg.mot).toFixed(2);
  
  q('#sumArmMat').value = s.arm.mat.toFixed(2);
  q('#sumArmMot').value = s.arm.mot.toFixed(2);
  q('#sebArm').value = (s.arm.mat + s.arm.mot).toFixed(2);
  
  q('#sumWrapMat').value = s.wrap.mat.toFixed(2);
  q('#sumWrapMot').value = s.wrap.mot.toFixed(2);
  q('#sebWrap').value = (s.wrap.mat + s.wrap.mot).toFixed(2);
  
  q('#sumDetMat').value = s.det.mat.toFixed(2);
  q('#sumDetMot').value = s.det.mot.toFixed(2);
  q('#sebDet').value = (s.det.mat + s.det.mot).toFixed(2);
  
  q('#sumGlMat').value = s.gl.mat.toFixed(2);
  q('#sumGlMot').value = s.gl.mot.toFixed(2);
  q('#sebGl').value = (s.gl.mat + s.gl.mot).toFixed(2);
  
  q('#sumMiscMat').value = s.ms.mat.toFixed(2);
  q('#sumMiscMot').value = s.ms.mot.toFixed(2);
  q('#sebMisc').value = (s.ms.mat + s.ms.mot).toFixed(2);
  
  const pkgTotal = s.pkg.mat + s.pkg.mot;
  const armTotal = s.arm.mat + s.arm.mot;
  const wrapTotal = s.wrap.mat + s.wrap.mot;
  const detTotal = s.det.mat + s.det.mot;
  const glTotal = s.gl.mat + s.gl.mot;
  const msTotal = s.ms.mat + s.ms.mot;
  
  const pkgCard = q('#sumPkgCard');
  const armCard = q('#sumArmCard');
  const wrapCard = q('#sumWrapCard');
  const detCard = q('#sumDetCard');
  const glCard = q('#sumGlCard');
  const miscCard = q('#sumMiscCard');
  
  if (pkgCard) pkgCard.style.display = pkgTotal > 0 ? 'block' : 'none';
  if (armCard) armCard.style.display = armTotal > 0 ? 'block' : 'none';
  if (wrapCard) wrapCard.style.display = wrapTotal > 0 ? 'block' : 'none';
  if (detCard) detCard.style.display = detTotal > 0 ? 'block' : 'none';
  if (glCard) glCard.style.display = glTotal > 0 ? 'block' : 'none';
  if (miscCard) miscCard.style.display = msTotal > 0 ? 'block' : 'none';
  
  const baseAll = pkgTotal + armTotal + wrapTotal + detTotal + glTotal + msTotal;
  
  const pkgMarkup = r100(pkgTotal * (mu.pkg || 0) / 100);
  const armMarkup = r100(armTotal * (mu.arm || 0) / 100);
  const detMarkup = r100(detTotal * (mu.det || 0) / 100);
  const glMarkup = r100(glTotal * (mu.gl || 0) / 100);
  const msMarkup = r100(msTotal * (mu.ms || 0) / 100);
  
  let wrapMarkup = 0;
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      const base = mat + mot;
      const markupToUse = (itemMarkup && itemMarkup > 0) ? itemMarkup : mu.wrap;
      wrapMarkup += r100(base * (markupToUse || 0) / 100);
    });
  } else {
    wrapMarkup = r100(wrapTotal * (mu.wrap || 0) / 100);
  }
  
  const totalMarkup = pkgMarkup + armMarkup + wrapMarkup + detMarkup + glMarkup + msMarkup;
  const markupWithDiscount = r100(totalMarkup * (1 - disc / 100));
  const afterMarkup = baseAll + markupWithDiscount;
  const taxK = taxCoef();
  const tax = r100(afterMarkup * taxK);
  const fin = afterMarkup + tax;
  
  q('#grandMat').textContent = fmt(s.pkg.mat + s.arm.mat + s.wrap.mat + s.det.mat + s.gl.mat + s.ms.mat);
  q('#grandMot').textContent = fmt(s.pkg.mot + s.arm.mot + s.wrap.mot + s.det.mot + s.gl.mot + s.ms.mot);
  q('#grandBase').textContent = fmt(baseAll);
  q('#grandMarkup').textContent = fmt(markupWithDiscount);
  q('#grandTax').textContent = fmt(tax);
  q('#finalTotal').textContent = fmt(fin);
  
  if (chart) {
    chart.data.datasets[0].data = [
      s.pkg.mat + s.arm.mat + s.wrap.mat + s.det.mat + s.gl.mat + s.ms.mat,
      s.pkg.mot + s.arm.mot + s.wrap.mot + s.det.mot + s.gl.mot + s.ms.mot,
      markupWithDiscount,
      tax
    ];
    chart.update('none');
  }
}

// Render All
function renderAll() {
  const s = collectAll();
  const mu = markups();
  renderBadges(s, mu);
  renderKP(s, mu);
  renderCost(s);
  renderWork(s);
  highlightMarkupFields(s, mu);
}

// Highlight Markup Fields
function highlightMarkupFields(s, mu) {
  const checks = [
    { sum: s.pkg.mat + s.pkg.mot, markup: mu.pkg, field: '#pkgMarkup' },
    { sum: s.arm.mat + s.arm.mot, markup: mu.arm, field: '#armMarkup' },
    { sum: s.wrap.mat + s.wrap.mot, markup: mu.wrap, field: '#wrapMarkup' },
    { sum: s.det.mat + s.det.mot, markup: mu.det, field: '#detMarkup' },
    { sum: s.gl.mat + s.gl.mot, markup: mu.gl, field: '#glMarkup' },
    { sum: s.ms.mat + s.ms.mot, markup: mu.ms, field: '#miscMarkup' }
  ];
  
  checks.forEach(c => {
    const field = q(c.field);
    if (!field) return;
    if (c.sum > 0 && (!c.markup || c.markup === 0)) {
      field.classList.add('markup-warning');
    } else {
      field.classList.remove('markup-warning');
    }
  });
}

// Init Theme
function initTheme() {
  const sv = localStorage.getItem('theme');
  const icon = q('#themeIcon');
  const body = document.body;
  
  if (sv === 'light') {
    body.setAttribute('data-theme', 'light');
    icon.textContent = 'üåô';
  } else {
    icon.textContent = '‚òÄÔ∏è';
  }
  
  // Toggle buttons
  qa('.toggle-btn').forEach(b => {
    b.addEventListener('click', () => {
      const r = b.querySelector('input[type=radio]');
      if (r) {
        r.checked = true;
        qa('.toggle-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        renderAll();
      }
    });
  });
  
  // Collapsible sections
  qa('.card h2.collapsible').forEach(h => {
    h.addEventListener('click', () => {
      h.classList.toggle('collapsed');
      h.nextElementSibling.classList.toggle('collapsed');
    });
  });
}

// Init Discounts
function initDiscounts() {
  qa('.discount-btn').forEach(b => {
    b.addEventListener('click', () => {
      disc = parseInt(b.dataset.discount) || 0;
      qa('.discount-btn').forEach(x => x.classList.toggle('active', parseInt(x.dataset.discount) === disc));
      q('#customDiscount').value = '';
      renderAll();
    });
  });
  
  q('#customDiscount')?.addEventListener('input', e => {
    const v = Math.max(0, Math.min(100, parseFloat(e.target.value) || 0));
    disc = v;
    qa('.discount-btn').forEach(b => b.classList.remove('active'));
    renderAll();
  });
}

// Init Chart
function initChart() {
  const ctx = q('#pieChart')?.getContext('2d');
  if (!ctx || !window.Chart) return;
  
  chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', '–ú–æ—Ç–∏–≤–∞—Ü–∏—è', '–ù–∞—Ü–µ–Ω–∫–∞', '–ù–∞–ª–æ–≥'],
      datasets: [{
        data: [0, 0, 0, 0],
        backgroundColor: [
          'rgba(59, 130, 246, 0.8)',
          'rgba(16, 185, 129, 0.8)',
          'rgba(245, 158, 11, 0.8)',
          'rgba(239, 68, 68, 0.8)'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: { size: 11, family: 'Inter' },
            padding: 12,
            color: 'rgba(241, 245, 249, 0.9)',
            usePointStyle: true,
            pointStyle: 'circle'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleFont: { size: 12, family: 'Inter', weight: '600' },
          bodyFont: { size: 11, family: 'Inter' },
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return context.label + ': ' + fmt(context.parsed) + ' ‚ÇΩ';
            }
          }
        }
      }
    }
  });
}

// Export PDF
function exportPDF(blockId, filename) {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF || !window.html2canvas) {
    alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ PDF –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...');
    return;
  }
  
  const holder = q('#pdfTemplates');
  const block = q(blockId);
  const orig = holder.style.display;
  holder.style.display = 'block';
  holder.style.position = 'absolute';
  holder.style.left = '-9999px';
  
  setTimeout(() => {
    html2canvas(block, { scale: 2, useCORS: true, backgroundColor: '#fff' }).then(canvas => {
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
      const pw = pdf.internal.pageSize.getWidth();
      const ph = pdf.internal.pageSize.getHeight();
      const iw = canvas.width;
      const ih = canvas.height;
      const ratio = Math.min(pw / iw, ph / ih);
      const sw = iw * ratio;
      const sh = ih * ratio;
      const x = (pw - sw) / 2;
      const y = 20;
      
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, sw, Math.min(sh, ph - 40));
      pdf.save(filename);
    }).catch(err => {
      alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF: ' + err.message);
    }).finally(() => {
      holder.style.display = orig;
    });
  }, 200);
}

// Prep KP
function prepKP() {
  const tb = q('#pdfKPTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
  qa('#kpTable tbody tr').forEach(tr => {
    const t = tr.children[0].textContent.trim();
    const d = tr.children[1].textContent.trim();
    const p = tr.children[2].textContent.trim();
    const r = document.createElement('tr');
    r.innerHTML = `<td style="width:25%">${t}</td><td style="width:50%">${d || '‚Äî'}</td><td style="width:25%">${p}</td>`;
    tb.appendChild(r);
  });
  
  q('#pdfKPTotal').textContent = q('#kpTotal')?.textContent || '0,00';
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '‚Äî';
  const now = new Date();
  const dateStr = now.toLocaleDateString('ru-RU');
  const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
  const payMode = q('input[name=payMode]:checked')?.value;
  const payText = payMode === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–µ' : payMode === 'card' ? '–ö–∞—Ä—Ç–∞' : payMode === 'ip' ? '–ò–ü' : '–û–û–û';
  
  q('#pdfKPMeta').innerHTML = `–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${br || '‚Äî'} ${md || '‚Äî'} ${yr}<br>–î–∞—Ç–∞: ${dateStr} ${timeStr}<br><b><i>–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã: ${payText}</i></b>`;
}

// Prep Cost
function prepCost() {
  const tb = q('#pdfCostTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
  qa('#costTable tbody tr').forEach(tr => {
    const c = tr.children;
    const r = document.createElement('tr');
    r.innerHTML = `<td>${c[0].textContent.trim()}</td><td>${c[1].textContent.trim()}</td><td>${c[2].textContent.trim()}</td>`;
    tb.appendChild(r);
  });
  
  q('#pdfCM').textContent = q('#cMat')?.textContent || '0,00';
  q('#pdfCO').textContent = q('#cMot')?.textContent || '0,00';
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '‚Äî';
  
  q('#pdfCostMeta').textContent = `–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${br || '‚Äî'} ${md || '‚Äî'} ${yr}`;
}

// Prep Work
function prepWork() {
  const tb = q('#pdfWorkTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
  qa('#workTable tbody tr').forEach((tr, idx) => {
    if (idx % 2 === 0) {
      const serviceName = tr.children[0]?.textContent?.trim() || '';
      const r1 = document.createElement('tr');
      r1.innerHTML = `<td rowspan="2">${serviceName}</td><td>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å 1</td><td></td><td></td><td></td>`;
      tb.appendChild(r1);
      
      const r2 = document.createElement('tr');
      r2.innerHTML = `<td>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å 2</td><td></td><td></td><td></td>`;
      tb.appendChild(r2);
    }
  });
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '‚Äî';
  
  q('#pdfWorkMeta').textContent = `–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${br || '‚Äî'} ${md || '‚Äî'} ${yr}`;
}

// Set Default Markups
function setDefaultMarkups() {
  ['#pkgMarkup', '#armMarkup', '#wrapMarkup', '#detMarkup', '#glMarkup', '#miscMarkup'].forEach(id => {
    const field = q(id);
    if (field) field.value = 40;
  });
}

// Format Number Input
function formatNumberInput(input) {
  const val = parseFloat(input.value);
  if (!isNaN(val) && val >= 0) {
    input.value = val.toFixed(2);
  }
}

// DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // Check Telegram
  const isTelegram = window.TelegramWebviewProxy !== undefined || navigator.userAgent.includes('Telegram');
  if (isTelegram) {
    const warning = q('#telegramWarning');
    if (warning) warning.style.display = 'block';
  }
  
  initTheme();
  initDiscounts();
  initChart();
  fillBrands();
  
  renderServiceList('#armContent', armServices, 'arm');
  renderWrapContent();
  renderPartialLists();
  renderServiceList('#detContent', detailServices, 'det');
  renderServiceList('#glContent', glassServices, 'gl');
  renderServiceList('#miscContent', miscServices, 'misc');
  renderSummaryCards();
  initServiceToggles();
  setDefaultMarkups();
  
  q('#brand')?.addEventListener('change', onBrandChange);
  q('#model')?.addEventListener('change', onModelChange);
  
  q('#btnAddArm')?.addEventListener('click', () => { addDynRow('#armDyn', 'arm'); initServiceToggles(); });
  q('#btnAddWrap')?.addEventListener('click', () => { addDynRow('#wrapDyn', 'wrap'); initServiceToggles(); });
  q('#btnAddDet')?.addEventListener('click', () => { addDynRow('#detDyn', 'det'); initServiceToggles(); });
  q('#btnAddGl')?.addEventListener('click', () => { addDynRow('#glDyn', 'gl'); initServiceToggles(); });
  q('#btnAddMisc')?.addEventListener('click', () => { addDynRow('#miscDyn', 'misc'); initServiceToggles(); });
  
  qa('input[name=payMode]').forEach(r => r.addEventListener('change', renderAll));
  
  q('#btnRecalc2')?.addEventListener('click', renderAll);
  q('#btnReset2')?.addEventListener('click', () => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) location.reload();
  });
  
  document.addEventListener('input', e => {
    if (e.target.matches('input[type="number"]')) {
      let val = parseFloat(e.target.value);
      if (!isNaN(val) && val < 0) {
        e.target.value = '';
      }
    }
    if (e.target.matches('input, select')) renderAll();
  });
  
  document.addEventListener('blur', e => {
    if (e.target.matches('input[type="number"]') && e.target.value !== '') {
      formatNumberInput(e.target);
      renderAll();
    }
  }, true);
  
  qa('.chip').forEach(ch => ch.addEventListener('click', () => {
    const sel = ch.getAttribute('data-markup-target');
    const tgt = q(sel);
    if (tgt) {
      tgt.value = ch.textContent.trim();
      renderAll();
    }
  }));
  
  q('#btnExportKP')?.addEventListener('click', () => {
    prepKP();
    setTimeout(() => exportPDF('#pdfKP', '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ_–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.pdf'), 100);
  });
  
  q('#btnExportCost')?.addEventListener('click', () => {
    prepCost();
    setTimeout(() => exportPDF('#pdfCost', '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å.pdf'), 100);
  });
  
  q('#btnExportWork')?.addEventListener('click', () => {
    prepWork();
    setTimeout(() => exportPDF('#pdfWork', '–ü–µ—Ä–µ—á–µ–Ω—å_—Ä–∞–±–æ—Ç.pdf'), 100);
  });
  
  renderAll();
});

})();
</script>
</body>
</html>
