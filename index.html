<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Калькулятор оклейки</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg: #f8fafc;
  --card: #fff;
  --text: #334155;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --primary: #3b82f6;
  --success: #10b981;
  --shadow: 0 1px 3px rgba(0,0,0,0.1);
}

[data-theme="dark"] {
  --bg: #1e293b;
  --card: #334155;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: #475569;
  --shadow: 0 4px 6px rgba(0,0,0,0.3);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  overflow-x: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  transition: all .3s;
  -webkit-tap-highlight-color: transparent;
}

/* Top Bar */
.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 16px;
}

.top-bar h1 {
  font-size: 1rem;
  font-weight: 600;
}

.theme-toggle {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  box-shadow: var(--shadow);
  font-size: 11px;
  font-weight: 500;
  min-height: 34px;
  display: flex;
  align-items: center;
}

/* Main Container - Adaptive Layout */
.main-container {
  padding-top: 60px;
  min-height: 100vh;
}

/* Mobile Layout (default) */
@media (max-width: 767px) {
  .main-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px;
  }
  
  .left-column,
  .right-column {
    width: 100%;
  }
}

/* Desktop Layout */
@media (min-width: 768px) {
  .main-container {
    display: flex;
    gap: 20px;
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
    align-items: flex-start;
  }
  
  .left-column {
    flex: 1;
    min-width: 0;
  }
  
  .right-column {
    width: 400px;
    min-width: 400px;
    max-width: 400px;
    flex-shrink: 0;
    position: sticky;
    top: 80px;
    align-self: flex-start;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
}

/* Card Styles */
.card {
  background: var(--card);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 20px;
  margin-bottom: 15px;
  border: 1px solid var(--border);
}

@media (min-width: 768px) {
  .card {
    padding: 24px;
    margin-bottom: 20px;
  }
}

.card h2 {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  min-height: 44px;
}

@media (min-width: 768px) {
  .card h2 {
    font-size: 1.25rem;
    margin-bottom: 16px;
  }
}

.card h2::before {
  content: '';
  width: 3px;
  height: 18px;
  background: linear-gradient(135deg, var(--primary), #1d4ed8);
  border-radius: 2px;
}

@media (min-width: 768px) {
  .card h2::before {
    width: 4px;
    height: 20px;
  }
}

.card h2.collapsible::after {
  content: '▼';
  margin-left: auto;
  transition: transform .2s;
  font-size: .8rem;
}

.card h2.collapsible.collapsed::after {
  transform: rotate(-90deg);
}

.card-content {
  transition: all .3s;
}

.card-content.collapsed {
  display: none;
}

/* Right column cards - no collapse on desktop */
@media (min-width: 768px) {
  .right-column .card h2 {
    cursor: default;
  }
  
  .right-column .card h2::after {
    display: none;
  }
  
  .right-column .card {
    padding: 16px;
    margin-bottom: 0;
  }
}

/* Form Elements */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 12px;
}

label {
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 4px;
  display: block;
  font-size: .9rem;
}

.markup-label {
  color: #d97706;
  font-weight: 600;
}

input,
select {
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 16px;
  transition: all .2s;
  background: var(--card);
  color: var(--text);
  width: 100%;
  min-height: 44px;
}

@media (min-width: 768px) {
  input,
  select {
    padding: 10px 12px;
    font-size: .9rem;
    min-height: auto;
  }
}

input.markup-warning {
  background: #fef3c7;
  border-color: #f59e0b;
}

input:focus,
select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, .1);
}

input:read-only {
  background: var(--bg);
  color: var(--text-muted);
}

/* Service Items */
.service-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.service-header {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}

.service-header input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin: 0;
  cursor: pointer;
  min-height: auto;
}

.service-header label {
  font-weight: 600;
  color: var(--text);
  font-size: .95rem;
  margin: 0;
  cursor: pointer;
  flex: 1;
}

.service-body {
  margin-top: 12px;
  display: none;
}

.service-body.open {
  display: block;
}

.service-fields {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  margin-bottom: 10px;
}

.service-complexity {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: .9rem;
  color: var(--text-muted);
}

.service-complexity input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin: 0;
  min-height: auto;
}

/* Partial Elements (PPF, PVC частично) */
.partial-wrapper {
  margin: 20px 0;
}

.partial-header {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  padding: 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  user-select: none;
}

.partial-header input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin: 0;
  cursor: pointer;
  min-height: auto;
}

.partial-header label {
  font-weight: 600;
  color: var(--text);
  font-size: .95rem;
  margin: 0;
  cursor: pointer;
  flex: 1;
}

.partial-content {
  margin-top: 12px;
  padding-left: 32px;
  display: none;
}

.partial-content.open {
  display: block;
}

/* Buttons */
.btn {
  padding: 12px 16px;
  border: none;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: all .2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  min-height: 44px;
  touch-action: manipulation;
}

@media (min-width: 768px) {
  .btn {
    padding: 10px 16px;
    font-size: .9rem;
  }
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), #1d4ed8);
  color: #fff;
}

.btn-primary:active {
  transform: scale(0.98);
}

.btn-secondary {
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:active {
  background: var(--border);
}

.btn-success {
  background: linear-gradient(135deg, var(--success), #059669);
  color: #fff;
}

.btn-success:active {
  transform: scale(0.98);
}

/* Chips (Quick select buttons) */
.chips {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.chip {
  padding: 10px 14px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  font-size: .9rem;
  cursor: pointer;
  transition: all .2s;
  color: var(--text);
  min-height: 40px;
  display: flex;
  align-items: center;
  touch-action: manipulation;
}

@media (min-width: 768px) {
  .chip {
    padding: 6px 10px;
    font-size: .8rem;
  }
}

.chip:active {
  background: var(--border);
  transform: scale(0.95);
}

/* Discount Buttons */
.discount-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin-top: 8px;
}

@media (min-width: 768px) {
  .discount-grid {
    grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
  }
}

.discount-btn {
  padding: 12px;
  background: #fef3c7;
  border: 1px solid #fbbf24;
  border-radius: 6px;
  font-size: .9rem;
  cursor: pointer;
  transition: all .2s;
  text-align: center;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  touch-action: manipulation;
  color: #000;
}

@media (min-width: 768px) {
  .discount-btn {
    padding: 8px 10px;
    font-size: .8rem;
  }
}

.discount-btn:active {
  background: #fde68a;
  transform: scale(0.95);
}

.discount-btn.active {
  background: #f59e0b;
  color: #fff;
}

[data-theme="dark"] .discount-btn {
  color: #000;
}

[data-theme="dark"] .discount-btn.active {
  color: #fff;
}

/* Toggle Group (Payment mode) */
.toggle-group {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.toggle-btn {
  flex: 1;
  min-width: calc(50% - 3px);
  justify-content: center;
  padding: 10px;
  font-size: .85rem;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  transition: all .2s;
  min-height: 44px;
  display: flex;
  align-items: center;
  touch-action: manipulation;
}

@media (min-width: 768px) {
  .toggle-btn {
    padding: 8px 14px;
  }
}

.toggle-btn.active {
  background: var(--primary);
  color: #fff;
  border-color: var(--primary);
}

.toggle-btn:active {
  transform: scale(0.98);
}

/* Tables */
.table-wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: .75rem;
  margin-top: 12px;
  min-width: 600px;
}

@media (min-width: 768px) {
  table {
    font-size: .85rem;
  }
}

th,
td {
  padding: 8px 6px;
  text-align: center;
  border: 1px solid var(--border);
}

@media (min-width: 768px) {
  th,
  td {
    padding: 8px 10px;
  }
}

th {
  background: var(--border);
  font-weight: 600;
  color: var(--text);
  font-size: .8rem;
}

tbody tr:hover {
  background: var(--border);
}

td:last-child {
  text-align: right;
}

#costTable td:nth-child(2),
#costTable td:nth-child(3) {
  text-align: right;
}

tfoot th {
  text-align: right;
}

tfoot th:first-child {
  text-align: left;
}

/* Totals Grid */
.totals-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  margin-top: 12px;
}

@media (min-width: 768px) {
  .totals-grid {
    grid-template-columns: 1fr 1fr;
  }
}

.total-item {
  text-align: center;
  padding: 12px;
  background: var(--border);
  border-radius: 6px;
  min-height: 60px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

@media (min-width: 768px) {
  .total-item {
    padding: 10px;
  }
}

.total-label {
  font-size: .85rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}

@media (min-width: 768px) {
  .total-label {
    font-size: .8rem;
  }
}

.total-value {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text);
}

.final-total {
  background: linear-gradient(135deg, var(--success), #059669);
  color: #fff;
}

@media (min-width: 768px) {
  .final-total {
    grid-column: 1 / -1;
  }
}

.final-total .total-value {
  color: #fff;
  font-size: 1.3rem;
}

.final-total .total-label {
  color: #fff;
}

[data-theme="dark"] .total-label {
  color: var(--text);
}

[data-theme="dark"] .final-total .total-label {
  color: #fff;
}

/* Chart */
.chart-container {
  position: relative;
  height: 180px;
  margin-top: 12px;
}

@media (min-width: 768px) {
  .chart-container {
    height: 200px;
  }
}

/* Export Buttons */
.export-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  flex-direction: column;
}

@media (min-width: 768px) {
  .export-buttons .btn {
    font-size: .8rem;
    padding: 8px 10px;
  }
}

/* Package Grid */
.package-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

@media (min-width: 768px) {
  .package-grid {
    grid-template-columns: 1fr 1fr;
  }
}

/* Summary Cards (Итоги по направлениям) */
.summary-cards {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}

/* Utility Classes */
.invis {
  display: none !important;
}

/* PDF Templates (hidden) */
#pdfTemplates {
  display: none;
  font-family: Arial, sans-serif;
  font-size: 12px;
  line-height: 1.4;
}

#pdfTemplates .pdf-block {
  width: 210mm;
  min-height: 297mm;
  padding: 20mm;
  background: #fff;
  color: #000;
}

#pdfTemplates h1 {
  font-size: 18px;
  margin-bottom: 10px;
  text-align: center;
}

#pdfTemplates table {
  width: 100%;
  border-collapse: collapse;
  margin: 10px 0;
}

#pdfTemplates th,
#pdfTemplates td {
  border: 1px solid #333;
  padding: 5px;
  text-align: left;
}

#pdfTemplates th {
  background: #f0f0f0;
  font-weight: bold;
}

/* Telegram Warning */
#telegramWarning {
  display: none;
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  font-size: .9rem;
  color: #856404;
}

[data-theme="dark"] #telegramWarning {
  background: #664d03;
  border-color: #997404;
  color: #ffecb5;
}
</style>
</head>
<body>
<div id="app">
<div class="top-bar">
  <h1>Калькулятор оклейки</h1>
  <div class="theme-toggle" onclick="toggleTheme()">
    <span id="themeIcon">Темная</span>
  </div>
</div>

<div class="main-container">
  <!-- LEFT COLUMN -->
  <div class="left-column">
    
    <!-- Автомобиль -->
    <div class="card">
      <h2>Автомобиль</h2>
      <div class="card-content">
        <div class="form-group">
          <label>Бренд:</label>
          <select id="brand">
            <option value="">Выберите бренд</option>
            <option value="manual">Ввести вручную</option>
          </select>
          <input type="text" id="brandManual" placeholder="Введите бренд" class="invis">
        </div>
        <div class="form-group">
          <label>Модель:</label>
          <select id="model">
            <option value="">Сначала выберите бренд</option>
            <option value="manual">Ввести вручную</option>
          </select>
          <input type="text" id="modelManual" placeholder="Введите модель" class="invis">
        </div>
        <div class="form-group">
          <label>Год:</label>
          <input type="number" id="year" min="1990" max="2040" placeholder="2020">
        </div>
      </div>
    </div>

    <!-- Полная защита вкруг -->
    <div class="card">
      <h2 class="collapsible collapsed">Полная защита вкруг</h2>
      <div class="card-content collapsed">
        <div class="package-grid">
          <div><label>Стоимость пленки:</label><input type="number" id="pkgWrapMat" placeholder="0" step="0.01"></div>
          <div><label>Мотивация оклейщика:</label><input type="number" id="pkgWrapMot" placeholder="0" step="0.01"></div>
          <div><label>Материалы подготовки:</label><input type="number" id="pkgPrepMat" placeholder="0" step="0.01"></div>
          <div><label>Мотивация подготовки:</label><input type="number" id="pkgPrepMot" placeholder="0" step="0.01"></div>
          <div><label>Материал арматурки:</label><input type="number" id="pkgArmMat" placeholder="0" step="0.01"></div>
          <div><label>Мотивация арматурщика:</label><input type="number" id="pkgArmMot" placeholder="0" step="0.01"></div>
        </div>
        <div style="margin-top:15px">
          <label class="markup-label">⚠️ Наценка на пакет (%):</label>
          <input type="number" id="pkgMarkup" placeholder="0" step="1">
          <div class="chips">
            <span class="chip" data-markup-target="#pkgMarkup">10</span>
            <span class="chip" data-markup-target="#pkgMarkup">20</span>
            <span class="chip" data-markup-target="#pkgMarkup">30</span>
            <span class="chip" data-markup-target="#pkgMarkup">40</span>
            <span class="chip" data-markup-target="#pkgMarkup">50</span>
            <span class="chip" data-markup-target="#pkgMarkup">60</span>
            <span class="chip" data-markup-target="#pkgMarkup">70</span>
            <span class="chip" data-markup-target="#pkgMarkup">80</span>
            <span class="chip" data-markup-target="#pkgMarkup">90</span>
            <span class="chip" data-markup-target="#pkgMarkup">100</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Форма оплаты -->
    <div class="card">
      <h2>Форма оплаты</h2>
      <div class="card-content">
        <div class="toggle-group">
          <label class="toggle-btn active">
            <input type="radio" name="payMode" value="cash" checked style="display:none">
            <span>Наличные (0%)</span>
          </label>
          <label class="toggle-btn">
            <input type="radio" name="payMode" value="card" style="display:none">
            <span>Карта (+8%)</span>
          </label>
          <label class="toggle-btn">
            <input type="radio" name="payMode" value="ip" style="display:none">
            <span>ИП (+8%)</span>
          </label>
          <label class="toggle-btn">
            <input type="radio" name="payMode" value="ooo" style="display:none">
            <span>ООО (+20%)</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Арматурные работы -->
    <div class="card">
      <h2 class="collapsible collapsed">Арматурные работы</h2>
      <div class="card-content collapsed" id="armContent"></div>
    </div>

    <!-- Оклейка автомобиля -->
    <div class="card">
      <h2 class="collapsible collapsed">Оклейка автомобиля</h2>
      <div class="card-content collapsed" id="wrapContent"></div>
    </div>

    <!-- Детейлинг -->
    <div class="card">
      <h2 class="collapsible collapsed">Детейлинг</h2>
      <div class="card-content collapsed" id="detContent"></div>
    </div>

    <!-- Стёкла -->
    <div class="card">
      <h2 class="collapsible collapsed">Стёкла</h2>
      <div class="card-content collapsed" id="glContent"></div>
    </div>

    <!-- Прочие работы -->
    <div class="card">
      <h2 class="collapsible collapsed">Прочие работы</h2>
      <div class="card-content collapsed" id="miscContent"></div>
    </div>

    <!-- Итоги по направлениям -->
    <div class="card">
      <h2>Итоги по направлениям</h2>
      <div class="card-content">
        <div class="summary-cards" id="summaryContent"></div>
      </div>
    </div>

    <!-- Предпросмотр КП -->
    <div class="card">
      <h2>Предпросмотр КП</h2>
      <div class="card-content">
        <div class="table-wrapper">
          <table id="kpTable">
            <thead><tr><th style="width:25%">Услуга</th><th style="width:50%">Описание</th><th style="width:25%">Стоимость</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="text-align:right;font-weight:bold;margin-top:10px">Итого: <span id="kpTotal">0,00</span> ₽</div>
      </div>
    </div>

    <!-- Предпросмотр себестоимости -->
    <div class="card">
      <h2>Предпросмотр себестоимости</h2>
      <div class="card-content">
        <div class="table-wrapper">
          <table id="costTable">
            <thead><tr><th style="width:50%">Услуга</th><th style="width:25%">Материалы</th><th style="width:25%">Мотивация</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="display:flex;justify-content:space-between;font-weight:bold;margin-top:10px;flex-wrap:wrap;gap:10px;font-size:.9rem">
          <span>Материалы: <span id="cMat">0,00</span> ₽</span>
          <span>Мотивация: <span id="cMot">0,00</span> ₽</span>
          <span>Итого: <span id="cTotal">0,00</span> ₽</span>
        </div>
      </div>
    </div>

    <!-- Предпросмотр перечня работ -->
    <div class="card">
      <h2>Предпросмотр перечня работ</h2>
      <div class="card-content">
        <div class="table-wrapper">
          <table id="workTable">
            <thead><tr><th style="width:35%">Услуга</th><th style="width:20%">Исполнитель</th><th style="width:15%">Дата приема</th><th style="width:15%">Дата выдачи</th><th style="width:15%">Подпись</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Action Buttons (desktop only) -->
    <div class="card" style="display:none">
      <div class="card-content">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <button type="button" class="btn btn-primary" id="btnRecalc">Пересчитать</button>
          <button type="button" class="btn btn-secondary" id="btnReset">Сброс</button>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT COLUMN -->
  <div class="right-column">
    
    <!-- Скидки -->
    <div class="card">
      <h2>Скидки</h2>
      <div class="card-content">
        <div class="discount-grid">
          <div class="discount-btn" data-discount="0">0%</div>
          <div class="discount-btn" data-discount="5">5%</div>
          <div class="discount-btn" data-discount="10">10%</div>
          <div class="discount-btn" data-discount="15">15%</div>
          <div class="discount-btn" data-discount="20">20%</div>
          <div class="discount-btn" data-discount="25">25%</div>
        </div>
        <div style="margin-top:8px">
          <input type="number" id="customDiscount" placeholder="Своя скидка %" min="0" max="100" step="0.01">
        </div>
      </div>
    </div>

    <!-- Итоги -->
    <div class="card">
      <h2>Итоги</h2>
      <div class="card-content">
        <div class="totals-grid">
          <div class="total-item"><div class="total-label">Материалы</div><div class="total-value" id="grandMat">0,00</div></div>
          <div class="total-item"><div class="total-label">Мотивация</div><div class="total-value" id="grandMot">0,00</div></div>
          <div class="total-item"><div class="total-label">Себестоимость</div><div class="total-value" id="grandBase">0,00</div></div>
          <div class="total-item"><div class="total-label">Наценка</div><div class="total-value" id="grandMarkup">0,00</div></div>
          <div class="total-item"><div class="total-label">Налог</div><div class="total-value" id="grandTax">0,00</div></div>
          <div class="total-item final-total"><div class="total-label">ИТОГО К ОПЛАТЕ</div><div class="total-value" id="finalTotal">0,00</div></div>
        </div>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Экспорт -->
    <div class="card">
      <h2>Экспорт</h2>
      <div class="card-content">
        <div id="telegramWarning">
          ⚠️ <b>Telegram WebView:</b> Для скачивания PDF откройте в браузере (••• → Открыть в браузере)
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
          <button type="button" class="btn btn-primary" id="btnRecalc2" style="flex:1;min-width:140px">Пересчитать</button>
          <button type="button" class="btn btn-secondary" id="btnReset2" style="flex:1;min-width:140px">Сброс</button>
        </div>
        <div class="export-buttons">
          <button type="button" class="btn btn-success" id="btnExportKP">КП (PDF)</button>
          <button type="button" class="btn btn-success" id="btnExportCost">Себес (PDF)</button>
          <button type="button" class="btn btn-success" id="btnExportWork">Перечень работ (PDF)</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PDF Templates -->
<div id="pdfTemplates">
  <div id="pdfKP" class="pdf-block">
    <h1>КОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ</h1>
    <p id="pdfKPMeta" style="text-align:center;margin-bottom:20px"></p>
    <table>
      <thead><tr><th style="width:25%">Услуга</th><th style="width:50%">Описание</th><th style="width:25%">Стоимость</th></tr></thead>
      <tbody id="pdfKPTBody"></tbody>
      <tfoot><tr><th colspan="2">ИТОГО:</th><th id="pdfKPTotal"></th></tr></tfoot>
    </table>
    <p style="text-align:center;margin-top:20px;font-style:italic">Коммерческое предложение актуально в течение 3х дней</p>
  </div>
  
  <div id="pdfCost" class="pdf-block">
    <h1>СЕБЕСТОИМОСТЬ</h1>
    <p id="pdfCostMeta" style="text-align:center;margin-bottom:20px"></p>
    <table>
      <thead><tr><th>Услуга</th><th>Материалы</th><th>Мотивация</th></tr></thead>
      <tbody id="pdfCostTBody"></tbody>
      <tfoot><tr><th>ИТОГО:</th><th id="pdfCM"></th><th id="pdfCO"></th></tr></tfoot>
    </table>
  </div>
  
  <div id="pdfWork" class="pdf-block">
    <h1>ПЕРЕЧЕНЬ РАБОТ</h1>
    <p id="pdfWorkMeta" style="text-align:center;margin-bottom:20px"></p>
    <table style="font-size:11px">
      <thead><tr><th style="width:35%">Услуга</th><th style="width:20%">Исполнитель</th><th style="width:15%">Дата приема</th><th style="width:15%">Дата выдачи</th><th style="width:15%">Подпись</th></tr></thead>
      <tbody id="pdfWorkTBody"></tbody>
    </table>
  </div>
</div>

</div>

<script>
(function() {
'use strict';

const q = s => document.querySelector(s);
const qa = s => document.querySelectorAll(s);
const fmt = n => parseFloat((n || 0).toFixed(2)).toLocaleString('ru-RU', {
  minimumFractionDigits: 2,
  maximumFractionDigits: 2
});
const r100 = n => Math.round((n || 0) * 100) / 100;

let disc = 0;
let chart = null;

// Car Database
const carDB = {
  Audi: ["A3", "A4", "A5", "A6", "Q3", "Q5", "Q7", "Q8"],
  BMW: ["1 Series", "3 Series", "5 Series", "7 Series", "X3", "X5"],
  BYD: ["Dolphin", "Han", "Qin Plus", "Seal", "Song Plus", "Tang", "Yuan Plus"],
  Changan: ["CS35 Plus", "CS55 Plus", "CS75 Plus", "Uni-K", "Uni-T"],
  Chery: ["Arrizo 5", "Tiggo 2", "Tiggo 4", "Tiggo 7", "Tiggo 8"],
  Ford: ["Explorer", "F-150", "Fiesta", "Focus", "Mustang"],
  Geely: ["Atlas", "Coolray", "Emgrand", "Monjaro", "Tugella"],
  Haval: ["Dargo", "F7", "F7x", "H6", "H9", "Jolion"],
  Honda: ["Accord", "Civic", "CR-V", "Fit", "HR-V"],
  Hyundai: ["Creta", "Elantra", "Santa Fe", "Sonata", "Tucson"],
  Kia: ["Cerato", "Ceed", "Rio", "Seltos", "Sorento", "Sportage"],
  Lixiang: ["I8", "L6", "L7", "L8", "L9", "Mega", "One"],
  Mazda: ["CX-3", "CX-30", "CX-5", "Mazda3", "Mazda6"],
  "Mercedes-Benz": ["A-Class", "C-Class", "E-Class", "GLC", "GLE", "S-Class"],
  Nissan: ["Altima", "Qashqai", "Rogue", "Sentra", "X-Trail"],
  Omoda: ["C5", "C7", "C9", "E5", "S5"],
  Tank: ["300", "400", "500", "700"],
  Tesla: ["Model 3", "Model S", "Model X", "Model Y"],
  Toyota: ["Camry", "Corolla", "Hilux", "Land Cruiser 300", "RAV4", "Yaris"],
  Volkswagen: ["Arteon", "Golf", "Passat", "Polo", "T-Roc", "Tiguan"],
  Voyah: ["Courage", "Dream", "Free", "Passion"],
  Zeekr: ["001", "007", "009", "7X", "9X", "Mix", "X"]
};

// Partial Elements
const partElements = [
  'Передний бампер', 'Задний бампер', 'Передний бампер (доп)', 'Задний бампер (доп)',
  'Передняя оптика', 'Противотуманные фары', 'Задние фонари', 'Решетка радиатора',
  'Полоска на капот', 'Капот', 'Переднее крыло', 'Два передних крыла',
  'Расширители арок', 'Стойки вокруг лобового', 'Полоска на крышу', 'Крыша',
  'Пороги', 'Пороги до замка', 'Дверные проемы', 'Передняя дверь',
  'Передние двери (2 шт)', 'Зона под ручками (2 шт)', 'Зона под ручками (4 шт)',
  'Задняя дверь', 'Задние двери (2 шт)', 'Заднее крыло', 'Задние крылья (2 шт)',
  'Крышка багажника', 'Багажник (доп)', 'Оклейка элементов интерьера', 'Антихром'
];

// Service Lists
const armServices = ['Демонтаж элементов', 'Монтаж элементов', 'Демонтаж и монтаж'];
const detailServices = [
  'Мойка кузова перед оклейкой', 'Подготовка кузова', 'Глубокая чистка кузова',
  'Полировка кузова', 'Нанесение составов на кузов', 'Химчистка салона',
  'Нанесение составов на элементы салона', 'Полировка глянцевых элементов'
];
const glassServices = [
  'Тонирование задней полусферы', 'Тонирование передних боковых стекол',
  'Тонирование лобового стекла', 'Бронирование лобового стекла'
];
const miscServices = [
  'Малярные работы', 'Выпрямление вмятин без покраски',
  'Реставрация ЛКП', 'Шумоизоляция'
];

// Theme Toggle
window.toggleTheme = function() {
  const body = document.body;
  const icon = q('#themeIcon');
  if (body.getAttribute('data-theme') === 'dark') {
    body.removeAttribute('data-theme');
    icon.textContent = 'Темная';
    localStorage.setItem('theme', 'light');
  } else {
    body.setAttribute('data-theme', 'dark');
    icon.textContent = 'Светлая';
    localStorage.setItem('theme', 'dark');
  }
};

// Fill Brands
function fillBrands() {
  const s = q('#brand');
  s.innerHTML = '<option value="">Выберите бренд</option><option value="manual">Ввести вручную</option>';
  Object.keys(carDB).sort().forEach(b => {
    const o = document.createElement('option');
    o.value = b;
    o.textContent = b;
    s.appendChild(o);
  });
}

// Brand Change
function onBrandChange() {
  const b = q('#brand').value;
  const m = q('#model');
  const bm = q('#brandManual');
  m.innerHTML = '<option value="">Выберите модель</option><option value="manual">Ввести вручную</option>';
  
  if (b && carDB[b]) {
    bm.classList.add('invis');
    carDB[b].forEach(md => {
      const o = document.createElement('option');
      o.value = md;
      o.textContent = md;
      m.appendChild(o);
    });
  } else if (b === 'manual') {
    bm.classList.remove('invis');
    m.innerHTML = '<option value="manual">Ввести вручную</option>';
  }
}

// Model Change
function onModelChange() {
  const m = q('#model').value;
  const mm = q('#modelManual');
  if (m === 'manual') mm.classList.remove('invis');
  else mm.classList.add('invis');
}

// Render Service List
function renderServiceList(containerId, services, classPrefix) {
  const container = q(containerId);
  let html = '';
  
  services.forEach((name, idx) => {
    html += `<div class="service-item">
      <div class="service-header">
        <input type="checkbox" class="${classPrefix}-chk" id="${classPrefix}${idx + 1}">
        <label for="${classPrefix}${idx + 1}">${name}</label>
      </div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>Материалы (₽):</label><input type="number" class="${classPrefix}-mat" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Мотивация (₽):</label><input type="number" class="${classPrefix}-mot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity">
          <input type="checkbox" class="${classPrefix}-complex" id="${classPrefix}${idx + 1}c">
          <label for="${classPrefix}${idx + 1}c">Усложнение +10%</label>
        </div>
      </div>
    </div>`;
  });
  
  html += `<div id="${classPrefix}Dyn"></div>
    <button type="button" class="btn btn-secondary" id="btnAdd${classPrefix.charAt(0).toUpperCase() + classPrefix.slice(1)}">Дополнительно</button>
    <div style="margin-top:15px">
      <label class="markup-label">Наценка (%):</label>
      <input type="number" id="${classPrefix}Markup" placeholder="0" step="1">
      <div class="chips">
        <span class="chip" data-markup-target="#${classPrefix}Markup">10</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">20</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">30</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">40</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">50</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">60</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">70</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">80</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">90</span>
        <span class="chip" data-markup-target="#${classPrefix}Markup">100</span>
      </div>
    </div>`;
  
  container.innerHTML = html;
}

// Render Wrap Content
function renderWrapContent() {
  const container = q('#wrapContent');
  let html = `<h3 style="margin-bottom:10px;font-size:1.05rem">PPF</h3>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfClearChk"><label for="ppfClearChk">PPF прозрачный вкруг</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>Метры (м):</label><input type="number" id="ppfClearM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Цена за метр (₽):</label><input type="number" id="ppfClearPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Мотивация (₽):</label><input type="number" id="ppfClearMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfClearComplex"><label for="ppfClearComplex">Усложнение +10%</label></div>
      </div>
    </div>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfColorChk"><label for="ppfColorChk">PPF цветной вкруг</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>Метры (м):</label><input type="number" id="ppfColorM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Цена за метр (₽):</label><input type="number" id="ppfColorPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Мотивация (₽):</label><input type="number" id="ppfColorMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfColorComplex"><label for="ppfColorComplex">Усложнение +10%</label></div>
      </div>
    </div>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="ppfMatChk"><label for="ppfMatChk">PPF матовый вкруг</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>Метры (м):</label><input type="number" id="ppfMatM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Цена за метр (₽):</label><input type="number" id="ppfMatPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Мотивация (₽):</label><input type="number" id="ppfMatMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="ppfMatComplex"><label for="ppfMatComplex">Усложнение +10%</label></div>
      </div>
    </div>
    <div class="partial-wrapper">
      <div class="partial-header"><input type="checkbox" id="ppfPartChk"><label for="ppfPartChk">PPF частично</label></div>
      <div class="partial-content" id="ppfPartContent"></div>
    </div>
    <h3 style="margin:20px 0 10px;font-size:1.05rem">PVC</h3>
    <div class="service-item">
      <div class="service-header"><input type="checkbox" id="pvcFullChk"><label for="pvcFullChk">ПВХ полная оклейка</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>Метры (м):</label><input type="number" id="pvcFullM" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Цена за метр (₽):</label><input type="number" id="pvcFullPrice" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Мотивация (₽):</label><input type="number" id="pvcFullMot" placeholder="0" step="0.01"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" id="pvcFullComplex"><label for="pvcFullComplex">Усложнение +10%</label></div>
      </div>
    </div>
    <div class="partial-wrapper">
      <div class="partial-header"><input type="checkbox" id="pvcPartChk"><label for="pvcPartChk">ПВХ частично</label></div>
      <div class="partial-content" id="pvcPartContent"></div>
    </div>
    <div id="wrapDyn"></div>
    <button type="button" class="btn btn-secondary" id="btnAddWrap">Дополнительно</button>
    <div style="margin-top:20px">
      <label class="markup-label">⚠️ Наценка на оклейку (%):</label>
      <input type="number" id="wrapMarkup" placeholder="0" step="1">
      <div class="chips">
        <span class="chip" data-markup-target="#wrapMarkup">10</span>
        <span class="chip" data-markup-target="#wrapMarkup">20</span>
        <span class="chip" data-markup-target="#wrapMarkup">30</span>
        <span class="chip" data-markup-target="#wrapMarkup">40</span>
        <span class="chip" data-markup-target="#wrapMarkup">50</span>
        <span class="chip" data-markup-target="#wrapMarkup">60</span>
        <span class="chip" data-markup-target="#wrapMarkup">70</span>
        <span class="chip" data-markup-target="#wrapMarkup">80</span>
        <span class="chip" data-markup-target="#wrapMarkup">90</span>
        <span class="chip" data-markup-target="#wrapMarkup">100</span>
      </div>
    </div>`;
  
  container.innerHTML = html;
}

// Render Partial Lists
function renderPartialLists() {
  const ppf = q('#ppfPartContent');
  const pvc = q('#pvcPartContent');
  let ppfHtml = '', pvcHtml = '';
  
  partElements.forEach((name, idx) => {
    ppfHtml += `<div class="service-item">
      <div class="service-header"><input type="checkbox" class="ppf-part-chk" id="ppfp${idx}"><label for="ppfp${idx}">${name}</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>Метры (м):</label><input type="number" class="ppf-part-m" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Цена за метр (₽):</label><input type="number" class="ppf-part-price" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Мотивация (₽):</label><input type="number" class="ppf-part-mot" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Своя наценка (%):</label><input type="number" class="ppf-part-markup" placeholder="0"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" class="ppf-part-complex" id="ppfp${idx}c"><label for="ppfp${idx}c">Усложнение +10%</label></div>
      </div>
    </div>`;
    
    pvcHtml += `<div class="service-item">
      <div class="service-header"><input type="checkbox" class="pvc-part-chk" id="pvcp${idx}"><label for="pvcp${idx}">${name}</label></div>
      <div class="service-body">
        <div class="service-fields">
          <div class="form-group"><label>Метры (м):</label><input type="number" class="pvc-part-m" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Цена за метр (₽):</label><input type="number" class="pvc-part-price" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Мотивация (₽):</label><input type="number" class="pvc-part-mot" placeholder="0" step="0.01"></div>
          <div class="form-group"><label>Своя наценка (%):</label><input type="number" class="pvc-part-markup" placeholder="0"></div>
        </div>
        <div class="service-complexity"><input type="checkbox" class="pvc-part-complex" id="pvcp${idx}c"><label for="pvcp${idx}c">Усложнение +10%</label></div>
      </div>
    </div>`;
  });
  
  ppf.innerHTML = ppfHtml;
  pvc.innerHTML = pvcHtml;
}

// Render Summary Cards
function renderSummaryCards() {
  const container = q('#summaryContent');
  const sections = [
    { id: 'Pkg', label: 'Полная защита' },
    { id: 'Arm', label: 'Арматурные' },
    { id: 'Wrap', label: 'Оклейка' },
    { id: 'Det', label: 'Детейлинг' },
    { id: 'Gl', label: 'Стёкла' },
    { id: 'Misc', label: 'Прочие' }
  ];
  
  let html = '';
  sections.forEach(s => {
    html += `<div class="service-item" id="sum${s.id}Card">
      <div class="service-header"><label style="flex:1">${s.label}</label></div>
      <div class="service-fields" style="display:grid">
        <div class="form-group"><label>Материалы:</label><input type="number" id="sum${s.id}Mat" readonly step="0.01"></div>
        <div class="form-group"><label>Мотивация:</label><input type="number" id="sum${s.id}Mot" readonly step="0.01"></div>
        <div class="form-group"><label>Себестоимость:</label><input type="number" id="seb${s.id}" readonly step="0.01"></div>
      </div>
    </div>`;
  });
  
  container.innerHTML = html;
}

// Add Dynamic Row
let dynCounter = 0;
function addDynRow(id, cls) {
  const c = q(id);
  const d = document.createElement('div');
  d.className = 'service-item';
  dynCounter++;
  d.innerHTML = `<div class="service-header">
    <input type="checkbox" checked id="dyn${cls}${dynCounter}">
    <label for="dyn${cls}${dynCounter}"><input type="text" placeholder="Название услуги" style="border:none;background:transparent;padding:0;font-weight:600;font-size:.95rem;color:var(--text);width:100%"></label>
  </div>
  <div class="service-body open">
    <div class="service-fields">
      <div class="form-group"><label>Материалы (₽):</label><input type="number" class="${cls}-mat" placeholder="0" step="0.01"></div>
      <div class="form-group"><label>Мотивация (₽):</label><input type="number" class="${cls}-mot" placeholder="0" step="0.01"></div>
    </div>
    <div class="service-complexity">
      <input type="checkbox" class="${cls}-complex" id="dyn${cls}${dynCounter}c">
      <label for="dyn${cls}${dynCounter}c">Усложнение +10%</label>
    </div>
  </div>`;
  c.appendChild(d);
}

// Init Service Toggles
function initServiceToggles() {
  qa('.service-item').forEach(item => {
    const chk = item.querySelector('.service-header input[type="checkbox"]');
    const body = item.querySelector('.service-body');
    const header = item.querySelector('.service-header');
    
    if (!chk || !body) return;
    
    header.onclick = function(e) {
      if (e.target === chk || e.target.tagName === 'INPUT') return;
      chk.click();
    };
    
    chk.onchange = function() {
      if (chk.checked) {
        body.classList.add('open');
      } else {
        body.classList.remove('open');
      }
    };
  });
  
  // PPF/PVC Partial toggles
  const ppfPartChk = q('#ppfPartChk');
  const ppfPartContent = q('#ppfPartContent');
  if (ppfPartChk && ppfPartContent) {
    ppfPartChk.onchange = function() {
      if (ppfPartChk.checked) {
        ppfPartContent.classList.add('open');
      } else {
        ppfPartContent.classList.remove('open');
      }
    };
  }
  
  const pvcPartChk = q('#pvcPartChk');
  const pvcPartContent = q('#pvcPartContent');
  if (pvcPartChk && pvcPartContent) {
    pvcPartChk.onchange = function() {
      if (pvcPartChk.checked) {
        pvcPartContent.classList.add('open');
      } else {
        pvcPartContent.classList.remove('open');
      }
    };
  }
}

// Collect All Data
function collectAll() {
  const sums = {
    pkg: { mat: 0, mot: 0, names: [] },
    arm: { mat: 0, mot: 0, names: [] },
    wrap: { mat: 0, mot: 0, details: [] },
    det: { mat: 0, mot: 0, names: [] },
    gl: { mat: 0, mot: 0, names: [] },
    ms: { mat: 0, mot: 0, names: [] }
  };
  
  // Package
  const pkgWrapMat = parseFloat(q('#pkgWrapMat')?.value) || 0;
  const pkgWrapMot = parseFloat(q('#pkgWrapMot')?.value) || 0;
  const pkgPrepMat = parseFloat(q('#pkgPrepMat')?.value) || 0;
  const pkgPrepMot = parseFloat(q('#pkgPrepMot')?.value) || 0;
  const pkgArmMat = parseFloat(q('#pkgArmMat')?.value) || 0;
  const pkgArmMot = parseFloat(q('#pkgArmMot')?.value) || 0;
  
  if (pkgWrapMat > 0 || pkgWrapMot > 0 || pkgPrepMat > 0 || pkgPrepMot > 0 || pkgArmMat > 0 || pkgArmMot > 0) {
    sums.pkg.mat = pkgWrapMat + pkgPrepMat + pkgArmMat;
    sums.pkg.mot = pkgWrapMot + pkgPrepMot + pkgArmMot;
    sums.pkg.names.push('Полная защита');
  }
  
  // Arm
  qa('.arm-chk').forEach(c => {
    if (c.checked) {
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let mat = parseFloat(item.querySelector('.arm-mat')?.value) || 0;
      let mot = parseFloat(item.querySelector('.arm-mot')?.value) || 0;
      if (item.querySelector('.arm-complex')?.checked) { mat *= 1.1; mot *= 1.1; }
      if (n && (mat > 0 || mot > 0)) {
        sums.arm.mat += mat;
        sums.arm.mot += mot;
        sums.arm.names.push(n);
      }
    }
  });
  
  qa('#armDyn .service-item').forEach(item => {
    const c = item.querySelector('input[type=checkbox]');
    if (c?.checked) {
      const n = item.querySelector('input[type=text]')?.value?.trim() || 'Название услуги';
      let mat = parseFloat(item.querySelector('.arm-mat')?.value) || 0;
      let mot = parseFloat(item.querySelector('.arm-mot')?.value) || 0;
      if (item.querySelector('.arm-complex')?.checked) { mat *= 1.1; mot *= 1.1; }
      if (mat > 0 || mot > 0) {
        sums.arm.mat += mat;
        sums.arm.mot += mot;
        sums.arm.names.push(n);
      }
    }
  });
  
  // Wrap - PPF Clear
  if (q('#ppfClearChk')?.checked) {
    const pr = parseFloat(q('#ppfClearPrice')?.value) || 0;
    let m = parseFloat(q('#ppfClearM')?.value) || 0;
    let mot = parseFloat(q('#ppfClearMot')?.value) || 0;
    if (q('#ppfClearComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF прозрачный вкруг', m, pr, mat, mot, 0]);
  }
  
  // PPF Color
  if (q('#ppfColorChk')?.checked) {
    const pr = parseFloat(q('#ppfColorPrice')?.value) || 0;
    let m = parseFloat(q('#ppfColorM')?.value) || 0;
    let mot = parseFloat(q('#ppfColorMot')?.value) || 0;
    if (q('#ppfColorComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF цветной вкруг', m, pr, mat, mot, 0]);
  }
  
  // PPF Mat
  if (q('#ppfMatChk')?.checked) {
    const pr = parseFloat(q('#ppfMatPrice')?.value) || 0;
    let m = parseFloat(q('#ppfMatM')?.value) || 0;
    let mot = parseFloat(q('#ppfMatMot')?.value) || 0;
    if (q('#ppfMatComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['PPF матовый вкруг', m, pr, mat, mot, 0]);
  }
  
  // PPF Partial
  qa('.ppf-part-chk').forEach(c => {
    if (c.checked) {
      const ppfPartMainChk = q('#ppfPartChk');
      if (!ppfPartMainChk || !ppfPartMainChk.checked) return;
      
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let m = parseFloat(item.querySelector('.ppf-part-m')?.value) || 0;
      const pr = parseFloat(item.querySelector('.ppf-part-price')?.value) || 0;
      let mot = parseFloat(item.querySelector('.ppf-part-mot')?.value) || 0;
      if (item.querySelector('.ppf-part-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        const itemMarkup = parseFloat(item.querySelector('.ppf-part-markup')?.value) || 0;
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([`PPF частично - ${n}`, m, pr, mat, mot, itemMarkup]);
      }
    }
  });
  
  // PVC Full
  if (q('#pvcFullChk')?.checked) {
    const pr = parseFloat(q('#pvcFullPrice')?.value) || 0;
    let m = parseFloat(q('#pvcFullM')?.value) || 0;
    let mot = parseFloat(q('#pvcFullMot')?.value) || 0;
    if (q('#pvcFullComplex')?.checked) { m *= 1.1; mot *= 1.1; }
    const mat = r100(m * pr);
    sums.wrap.mat += mat;
    sums.wrap.mot += mot;
    sums.wrap.details.push(['ПВХ полная оклейка', m, pr, mat, mot, 0]);
  }
  
  // PVC Partial
  qa('.pvc-part-chk').forEach(c => {
    if (c.checked) {
      const pvcPartMainChk = q('#pvcPartChk');
      if (!pvcPartMainChk || !pvcPartMainChk.checked) return;
      
      const item = c.closest('.service-item');
      const n = item.querySelector('.service-header label')?.textContent?.trim();
      let m = parseFloat(item.querySelector('.pvc-part-m')?.value) || 0;
      const pr = parseFloat(item.querySelector('.pvc-part-price')?.value) || 0;
      let mot = parseFloat(item.querySelector('.pvc-part-mot')?.value) || 0;
      if (item.querySelector('.pvc-part-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        const itemMarkup = parseFloat(item.querySelector('.pvc-part-markup')?.value) || 0;
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([`ПВХ частично - ${n}`, m, pr, mat, mot, itemMarkup]);
      }
    }
  });
  
  // Wrap Dynamic
  qa('#wrapDyn .service-item').forEach(item => {
    const c = item.querySelector('input[type=checkbox]');
    if (c?.checked) {
      const n = item.querySelector('input[type=text]')?.value?.trim() || 'Название услуги';
      let m = parseFloat(item.querySelectorAll('input[type=number]')[0]?.value) || 0;
      const pr = parseFloat(item.querySelectorAll('input[type=number]')[1]?.value) || 0;
      let mot = parseFloat(item.querySelectorAll('input[type=number]')[2]?.value) || 0;
      if (item.querySelector('.wrap-complex')?.checked) { m *= 1.1; mot *= 1.1; }
      
      if (m > 0 || pr > 0 || mot > 0) {
        const mat = r100(m * pr);
        sums.wrap.mat += mat;
        sums.wrap.mot += mot;
        sums.wrap.details.push([n, m, pr, mat, mot, 0]);
      }
    }
  });
  
  // Det, Gl, Misc
  ['det', 'gl', 'misc'].forEach(tp => {
    const key = tp === 'misc' ? 'ms' : tp;
    
    qa(`.${tp}-chk`).forEach(c => {
      if (c.checked) {
        const item = c.closest('.service-item');
        const n = item.querySelector('.service-header label')?.textContent?.trim();
        let mat = parseFloat(item.querySelector(`.${tp}-mat`)?.value) || 0;
        let mot = parseFloat(item.querySelector(`.${tp}-mot`)?.value) || 0;
        if (item.querySelector(`.${tp}-complex`)?.checked) { mat *= 1.1; mot *= 1.1; }
        if (n && (mat > 0 || mot > 0)) {
          sums[key].mat += mat;
          sums[key].mot += mot;
          sums[key].names.push(n);
        }
      }
    });
    
    qa(`#${tp}Dyn .service-item`).forEach(item => {
      const c = item.querySelector('input[type=checkbox]');
      if (c?.checked) {
        const n = item.querySelector('input[type=text]')?.value?.trim() || 'Название услуги';
        let mat = parseFloat(item.querySelector(`.${tp}-mat`)?.value) || 0;
        let mot = parseFloat(item.querySelector(`.${tp}-mot`)?.value) || 0;
        if (item.querySelector(`.${tp}-complex`)?.checked) { mat *= 1.1; mot *= 1.1; }
        if (mat > 0 || mot > 0) {
          sums[key].mat += mat;
          sums[key].mot += mot;
          sums[key].names.push(n);
        }
      }
    });
  });
  
  return sums;
}

// Tax Coefficient
function taxCoef() {
  const m = q('input[name=payMode]:checked')?.value;
  return m === 'card' ? 0.08 : m === 'ip' ? 0.08 : m === 'ooo' ? 0.20 : 0;
}

// Markups
function markups() {
  return {
    pkg: parseFloat(q('#pkgMarkup')?.value) || 0,
    arm: parseFloat(q('#armMarkup')?.value) || 0,
    wrap: parseFloat(q('#wrapMarkup')?.value) || 0,
    det: parseFloat(q('#detMarkup')?.value) || 0,
    gl: parseFloat(q('#glMarkup')?.value) || 0,
    ms: parseFloat(q('#miscMarkup')?.value) || 0
  };
}

// Render KP
function renderKP(s, mu) {
  const tb = q('#kpTable tbody');
  if (!tb) return;
  tb.innerHTML = '';
  
  const taxK = taxCoef();
  let tot = 0;
  
  const rows = [
    { t: 'Полная защита', det: 'Полная защита глянцевых кузовных элементов автомобиля с разбором съемных элементов и подготовкой кузова', sum: s.pkg, mu: mu.pkg },
    { t: 'Арматурные', det: 'Демонтаж и монтаж съемных элементов кузова', sum: s.arm, mu: mu.arm },
    { t: 'Детейлинг', det: 'Комплексная чистка и подготовка кузова и салона автомобиля', sum: s.det, mu: mu.det },
    { t: 'Стёкла', det: 'Тонирование и защита стекол автомобиля', sum: s.gl, mu: mu.gl },
    { t: 'Прочие', det: 'Дополнительные работы по кузову автомобиля', sum: s.ms, mu: mu.ms }
  ];
  
  rows.forEach(r => {
    const base = r.sum.mat + r.sum.mot;
    if (base <= 0) return;
    
    const markupAmount = r100(base * (r.mu || 0) / 100);
    const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
    let pr = base + markupWithDiscount;
    pr = r100(pr * (1 + taxK));
    tot += pr;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${r.t}</td><td style="text-align:left">${r.det || '—'}</td><td>${fmt(pr)}</td>`;
    tb.appendChild(tr);
  });
  
  // Wrap details
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      const base = mat + mot;
      if (base <= 0) return;
      
      const markupToUse = (itemMarkup && itemMarkup > 0) ? itemMarkup : mu.wrap;
      const markupAmount = r100(base * (markupToUse || 0) / 100);
      const markupWithDiscount = r100(markupAmount * (1 - disc / 100));
      let pr = base + markupWithDiscount;
      pr = r100(pr * (1 + taxK));
      tot += pr;
      
      const tr = document.createElement('tr');
      const displayName = name.includes('PPF') || name.includes('ПВХ') ? 'Оклейка' : 'Оклейка';
      const displayDesc = name.includes('вкруг') ? 'Полная защита глянцевых кузовных элементов автомобиля' : name;
      tr.innerHTML = `<td style="text-align:left">${displayName}</td><td style="text-align:left">${displayDesc}</td><td>${fmt(pr)}</td>`;
      tb.appendChild(tr);
    });
  }
  
  q('#kpTotal').textContent = fmt(tot);
}

// Render Cost
function renderCost(s) {
  const tb = q('#costTable tbody');
  if (!tb) return;
  tb.innerHTML = '';
  
  const rows = [
    { t: 'Полная защита', sum: s.pkg },
    { t: 'Арматурные', sum: s.arm },
    { t: 'Детейлинг', sum: s.det },
    { t: 'Стёкла', sum: s.gl },
    { t: 'Прочие', sum: s.ms }
  ];
  
  let totM = 0, totO = 0;
  
  rows.forEach(r => {
    const base = r.sum.mat + r.sum.mot;
    if (base <= 0) return;
    
    totM += r.sum.mat;
    totO += r.sum.mot;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${r.t}</td><td>${fmt(r.sum.mat)}</td><td>${fmt(r.sum.mot)}</td>`;
    tb.appendChild(tr);
  });
  
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      if (mat <= 0 && mot <= 0) return;
      
      totM += mat;
      totO += mot;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="text-align:left">${name}</td><td>${fmt(mat)}</td><td>${fmt(mot)}</td>`;
      tb.appendChild(tr);
    });
  }
  
  q('#cMat').textContent = fmt(totM);
  q('#cMot').textContent = fmt(totO);
  q('#cTotal').textContent = fmt(totM + totO);
}

// Render Work
function renderWork(s) {
  const tb = q('#workTable tbody');
  if (!tb) return;
  tb.innerHTML = '';
  
  const rows = [
    { t: 'Полная защита', sum: s.pkg },
    { t: 'Арматурные', sum: s.arm },
    { t: 'Детейлинг', sum: s.det },
    { t: 'Стёкла', sum: s.gl },
    { t: 'Прочие', sum: s.ms }
  ];
  
  rows.forEach(r => {
    const base = r.sum.mat + r.sum.mot;
    if (base <= 0) return;
    
    const tr1 = document.createElement('tr');
    tr1.innerHTML = `<td style="text-align:left" rowspan="2">${r.t}</td><td>Исполнитель 1</td><td></td><td></td><td></td>`;
    tb.appendChild(tr1);
    
    const tr2 = document.createElement('tr');
    tr2.innerHTML = `<td>Исполнитель 2</td><td></td><td></td><td></td>`;
    tb.appendChild(tr2);
  });
  
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      if (mat <= 0 && mot <= 0) return;
      
      const tr1 = document.createElement('tr');
      tr1.innerHTML = `<td style="text-align:left" rowspan="2">${name}</td><td>Исполнитель 1</td><td></td><td></td><td></td>`;
      tb.appendChild(tr1);
      
      const tr2 = document.createElement('tr');
      tr2.innerHTML = `<td>Исполнитель 2</td><td></td><td></td><td></td>`;
      tb.appendChild(tr2);
    });
  }
}

// Render Badges
function renderBadges(s, mu) {
  q('#sumPkgMat').value = s.pkg.mat.toFixed(2);
  q('#sumPkgMot').value = s.pkg.mot.toFixed(2);
  q('#sebPkg').value = (s.pkg.mat + s.pkg.mot).toFixed(2);
  
  q('#sumArmMat').value = s.arm.mat.toFixed(2);
  q('#sumArmMot').value = s.arm.mot.toFixed(2);
  q('#sebArm').value = (s.arm.mat + s.arm.mot).toFixed(2);
  
  q('#sumWrapMat').value = s.wrap.mat.toFixed(2);
  q('#sumWrapMot').value = s.wrap.mot.toFixed(2);
  q('#sebWrap').value = (s.wrap.mat + s.wrap.mot).toFixed(2);
  
  q('#sumDetMat').value = s.det.mat.toFixed(2);
  q('#sumDetMot').value = s.det.mot.toFixed(2);
  q('#sebDet').value = (s.det.mat + s.det.mot).toFixed(2);
  
  q('#sumGlMat').value = s.gl.mat.toFixed(2);
  q('#sumGlMot').value = s.gl.mot.toFixed(2);
  q('#sebGl').value = (s.gl.mat + s.gl.mot).toFixed(2);
  
  q('#sumMiscMat').value = s.ms.mat.toFixed(2);
  q('#sumMiscMot').value = s.ms.mot.toFixed(2);
  q('#sebMisc').value = (s.ms.mat + s.ms.mot).toFixed(2);
  
  const pkgTotal = s.pkg.mat + s.pkg.mot;
  const armTotal = s.arm.mat + s.arm.mot;
  const wrapTotal = s.wrap.mat + s.wrap.mot;
  const detTotal = s.det.mat + s.det.mot;
  const glTotal = s.gl.mat + s.gl.mot;
  const msTotal = s.ms.mat + s.ms.mot;
  
  const pkgCard = q('#sumPkgCard');
  const armCard = q('#sumArmCard');
  const wrapCard = q('#sumWrapCard');
  const detCard = q('#sumDetCard');
  const glCard = q('#sumGlCard');
  const miscCard = q('#sumMiscCard');
  
  if (pkgCard) pkgCard.style.display = pkgTotal > 0 ? 'block' : 'none';
  if (armCard) armCard.style.display = armTotal > 0 ? 'block' : 'none';
  if (wrapCard) wrapCard.style.display = wrapTotal > 0 ? 'block' : 'none';
  if (detCard) detCard.style.display = detTotal > 0 ? 'block' : 'none';
  if (glCard) glCard.style.display = glTotal > 0 ? 'block' : 'none';
  if (miscCard) miscCard.style.display = msTotal > 0 ? 'block' : 'none';
  
  const baseAll = pkgTotal + armTotal + wrapTotal + detTotal + glTotal + msTotal;
  
  const pkgMarkup = r100(pkgTotal * (mu.pkg || 0) / 100);
  const armMarkup = r100(armTotal * (mu.arm || 0) / 100);
  const detMarkup = r100(detTotal * (mu.det || 0) / 100);
  const glMarkup = r100(glTotal * (mu.gl || 0) / 100);
  const msMarkup = r100(msTotal * (mu.ms || 0) / 100);
  
  let wrapMarkup = 0;
  if (s.wrap.details && s.wrap.details.length > 0) {
    s.wrap.details.forEach(detail => {
      const [name, meters, price, mat, mot, itemMarkup] = detail;
      const base = mat + mot;
      const markupToUse = (itemMarkup && itemMarkup > 0) ? itemMarkup : mu.wrap;
      wrapMarkup += r100(base * (markupToUse || 0) / 100);
    });
  } else {
    wrapMarkup = r100(wrapTotal * (mu.wrap || 0) / 100);
  }
  
  const totalMarkup = pkgMarkup + armMarkup + wrapMarkup + detMarkup + glMarkup + msMarkup;
  const markupWithDiscount = r100(totalMarkup * (1 - disc / 100));
  const afterMarkup = baseAll + markupWithDiscount;
  const taxK = taxCoef();
  const tax = r100(afterMarkup * taxK);
  const fin = afterMarkup + tax;
  
  q('#grandMat').textContent = fmt(s.pkg.mat + s.arm.mat + s.wrap.mat + s.det.mat + s.gl.mat + s.ms.mat);
  q('#grandMot').textContent = fmt(s.pkg.mot + s.arm.mot + s.wrap.mot + s.det.mot + s.gl.mot + s.ms.mot);
  q('#grandBase').textContent = fmt(baseAll);
  q('#grandMarkup').textContent = fmt(markupWithDiscount);
  q('#grandTax').textContent = fmt(tax);
  q('#finalTotal').textContent = fmt(fin);
  
  if (chart) {
    chart.data.datasets[0].data = [
      s.pkg.mat + s.arm.mat + s.wrap.mat + s.det.mat + s.gl.mat + s.ms.mat,
      s.pkg.mot + s.arm.mot + s.wrap.mot + s.det.mot + s.gl.mot + s.ms.mot,
      markupWithDiscount,
      tax
    ];
    chart.update('none');
  }
}

// Render All
function renderAll() {
  const s = collectAll();
  const mu = markups();
  renderBadges(s, mu);
  renderKP(s, mu);
  renderCost(s);
  renderWork(s);
  highlightMarkupFields(s, mu);
}

// Highlight Markup Fields
function highlightMarkupFields(s, mu) {
  const checks = [
    { sum: s.pkg.mat + s.pkg.mot, markup: mu.pkg, field: '#pkgMarkup' },
    { sum: s.arm.mat + s.arm.mot, markup: mu.arm, field: '#armMarkup' },
    { sum: s.wrap.mat + s.wrap.mot, markup: mu.wrap, field: '#wrapMarkup' },
    { sum: s.det.mat + s.det.mot, markup: mu.det, field: '#detMarkup' },
    { sum: s.gl.mat + s.gl.mot, markup: mu.gl, field: '#glMarkup' },
    { sum: s.ms.mat + s.ms.mot, markup: mu.ms, field: '#miscMarkup' }
  ];
  
  checks.forEach(c => {
    const field = q(c.field);
    if (!field) return;
    if (c.sum > 0 && (!c.markup || c.markup === 0)) {
      field.classList.add('markup-warning');
    } else {
      field.classList.remove('markup-warning');
    }
  });
}

// Init Theme
function initTheme() {
  const sv = localStorage.getItem('theme');
  const icon = q('#themeIcon');
  const body = document.body;
  
  if (sv === 'dark') {
    body.setAttribute('data-theme', 'dark');
    icon.textContent = 'Светлая';
  }
  
  // Toggle buttons
  qa('.toggle-btn').forEach(b => {
    b.addEventListener('click', () => {
      const r = b.querySelector('input[type=radio]');
      if (r) {
        r.checked = true;
        qa('.toggle-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        renderAll();
      }
    });
  });
  
  // Collapsible sections
  qa('.card h2.collapsible').forEach(h => {
    h.addEventListener('click', () => {
      h.classList.toggle('collapsed');
      h.nextElementSibling.classList.toggle('collapsed');
    });
  });
}

// Init Discounts
function initDiscounts() {
  qa('.discount-btn').forEach(b => {
    b.addEventListener('click', () => {
      disc = parseInt(b.dataset.discount) || 0;
      qa('.discount-btn').forEach(x => x.classList.toggle('active', parseInt(x.dataset.discount) === disc));
      q('#customDiscount').value = '';
      renderAll();
    });
  });
  
  q('#customDiscount')?.addEventListener('input', e => {
    const v = Math.max(0, Math.min(100, parseFloat(e.target.value) || 0));
    disc = v;
    qa('.discount-btn').forEach(b => b.classList.remove('active'));
    renderAll();
  });
}

// Init Chart
function initChart() {
  const ctx = q('#pieChart')?.getContext('2d');
  if (!ctx || !window.Chart) return;
  
  chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Материалы', 'Мотивация', 'Наценка', 'Налог'],
      datasets: [{
        data: [0, 0, 0, 0],
        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            font: { size: 11 },
            padding: 10
          }
        }
      }
    }
  });
}

// Export PDF
function exportPDF(blockId, filename) {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF || !window.html2canvas) {
    alert('Библиотеки PDF загружаются...');
    return;
  }
  
  const holder = q('#pdfTemplates');
  const block = q(blockId);
  const orig = holder.style.display;
  holder.style.display = 'block';
  holder.style.position = 'absolute';
  holder.style.left = '-9999px';
  
  setTimeout(() => {
    html2canvas(block, { scale: 2, useCORS: true, backgroundColor: '#fff' }).then(canvas => {
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
      const pw = pdf.internal.pageSize.getWidth();
      const ph = pdf.internal.pageSize.getHeight();
      const iw = canvas.width;
      const ih = canvas.height;
      const ratio = Math.min(pw / iw, ph / ih);
      const sw = iw * ratio;
      const sh = ih * ratio;
      const x = (pw - sw) / 2;
      const y = 20;
      
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, sw, Math.min(sh, ph - 40));
      pdf.save(filename);
    }).catch(err => {
      alert('Ошибка создания PDF: ' + err.message);
    }).finally(() => {
      holder.style.display = orig;
    });
  }, 200);
}

// Prep KP
function prepKP() {
  const tb = q('#pdfKPTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
  qa('#kpTable tbody tr').forEach(tr => {
    const t = tr.children[0].textContent.trim();
    const d = tr.children[1].textContent.trim();
    const p = tr.children[2].textContent.trim();
    const r = document.createElement('tr');
    r.innerHTML = `<td style="width:25%">${t}</td><td style="width:50%">${d || '—'}</td><td style="width:25%">${p}</td>`;
    tb.appendChild(r);
  });
  
  q('#pdfKPTotal').textContent = q('#kpTotal')?.textContent || '0,00';
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '—';
  const now = new Date();
  const dateStr = now.toLocaleDateString('ru-RU');
  const timeStr = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
  const payMode = q('input[name=payMode]:checked')?.value;
  const payText = payMode === 'cash' ? 'Наличные' : payMode === 'card' ? 'Карта' : payMode === 'ip' ? 'ИП' : 'ООО';
  
  q('#pdfKPMeta').innerHTML = `Автомобиль: ${br || '—'} ${md || '—'} ${yr}<br>Дата: ${dateStr} ${timeStr}<br><b><i>Условия оплаты: ${payText}</i></b>`;
}

// Prep Cost
function prepCost() {
  const tb = q('#pdfCostTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
  qa('#costTable tbody tr').forEach(tr => {
    const c = tr.children;
    const r = document.createElement('tr');
    r.innerHTML = `<td>${c[0].textContent.trim()}</td><td>${c[1].textContent.trim()}</td><td>${c[2].textContent.trim()}</td>`;
    tb.appendChild(r);
  });
  
  q('#pdfCM').textContent = q('#cMat')?.textContent || '0,00';
  q('#pdfCO').textContent = q('#cMot')?.textContent || '0,00';
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '—';
  
  q('#pdfCostMeta').textContent = `Автомобиль: ${br || '—'} ${md || '—'} ${yr}`;
}

// Prep Work
function prepWork() {
  const tb = q('#pdfWorkTBody');
  if (!tb) return;
  tb.innerHTML = '';
  
  qa('#workTable tbody tr').forEach((tr, idx) => {
    if (idx % 2 === 0) {
      const serviceName = tr.children[0]?.textContent?.trim() || '';
      const r1 = document.createElement('tr');
      r1.innerHTML = `<td rowspan="2">${serviceName}</td><td>Исполнитель 1</td><td></td><td></td><td></td>`;
      tb.appendChild(r1);
      
      const r2 = document.createElement('tr');
      r2.innerHTML = `<td>Исполнитель 2</td><td></td><td></td><td></td>`;
      tb.appendChild(r2);
    }
  });
  
  const br = q('#brandManual').classList.contains('invis') ? q('#brand').value : q('#brandManual').value;
  const md = q('#modelManual').classList.contains('invis') ? q('#model').value : q('#modelManual').value;
  const yr = q('#year').value || '—';
  
  q('#pdfWorkMeta').textContent = `Автомобиль: ${br || '—'} ${md || '—'} ${yr}`;
}

// Set Default Markups
function setDefaultMarkups() {
  ['#pkgMarkup', '#armMarkup', '#wrapMarkup', '#detMarkup', '#glMarkup', '#miscMarkup'].forEach(id => {
    const field = q(id);
    if (field) field.value = 40;
  });
}

// Format Number Input
function formatNumberInput(input) {
  const val = parseFloat(input.value);
  if (!isNaN(val) && val >= 0) {
    input.value = val.toFixed(2);
  }
}

// DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
  // Check Telegram
  const isTelegram = window.TelegramWebviewProxy !== undefined || navigator.userAgent.includes('Telegram');
  if (isTelegram) {
    const warning = q('#telegramWarning');
    if (warning) warning.style.display = 'block';
  }
  
  initTheme();
  initDiscounts();
  initChart();
  fillBrands();
  
  renderServiceList('#armContent', armServices, 'arm');
  renderWrapContent();
  renderPartialLists();
  renderServiceList('#detContent', detailServices, 'det');
  renderServiceList('#glContent', glassServices, 'gl');
  renderServiceList('#miscContent', miscServices, 'misc');
  renderSummaryCards();
  initServiceToggles();
  setDefaultMarkups();
  
  q('#brand')?.addEventListener('change', onBrandChange);
  q('#model')?.addEventListener('change', onModelChange);
  
  q('#btnAddArm')?.addEventListener('click', () => { addDynRow('#armDyn', 'arm'); initServiceToggles(); });
  q('#btnAddWrap')?.addEventListener('click', () => { addDynRow('#wrapDyn', 'wrap'); initServiceToggles(); });
  q('#btnAddDet')?.addEventListener('click', () => { addDynRow('#detDyn', 'det'); initServiceToggles(); });
  q('#btnAddGl')?.addEventListener('click', () => { addDynRow('#glDyn', 'gl'); initServiceToggles(); });
  q('#btnAddMisc')?.addEventListener('click', () => { addDynRow('#miscDyn', 'misc'); initServiceToggles(); });
  
  qa('input[name=payMode]').forEach(r => r.addEventListener('change', renderAll));
  
  q('#btnRecalc')?.addEventListener('click', renderAll);
  q('#btnRecalc2')?.addEventListener('click', renderAll);
  q('#btnReset')?.addEventListener('click', () => {
    if (confirm('Вы уверены, что хотите сбросить все данные?')) location.reload();
  });
  q('#btnReset2')?.addEventListener('click', () => {
    if (confirm('Вы уверены, что хотите сбросить все данные?')) location.reload();
  });
  
  document.addEventListener('input', e => {
    if (e.target.matches('input[type="number"]')) {
      let val = parseFloat(e.target.value);
      if (!isNaN(val) && val < 0) {
        e.target.value = '';
      }
    }
    if (e.target.matches('input, select')) renderAll();
  });
  
  document.addEventListener('blur', e => {
    if (e.target.matches('input[type="number"]') && e.target.value !== '') {
      formatNumberInput(e.target);
      renderAll();
    }
  }, true);
  
  qa('.chip').forEach(ch => ch.addEventListener('click', () => {
    const sel = ch.getAttribute('data-markup-target');
    const tgt = q(sel);
    if (tgt) {
      tgt.value = ch.textContent.trim();
      renderAll();
    }
  }));
  
  q('#btnExportKP')?.addEventListener('click', () => {
    prepKP();
    setTimeout(() => exportPDF('#pdfKP', 'Коммерческое_предложение.pdf'), 100);
  });
  
  q('#btnExportCost')?.addEventListener('click', () => {
    prepCost();
    setTimeout(() => exportPDF('#pdfCost', 'Себестоимость.pdf'), 100);
  });
  
  q('#btnExportWork')?.addEventListener('click', () => {
    prepWork();
    setTimeout(() => exportPDF('#pdfWork', 'Перечень_работ.pdf'), 100);
  });
  
  renderAll();
});

})();
</script>
</body>
</html>
